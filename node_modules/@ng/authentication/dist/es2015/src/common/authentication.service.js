/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject, Injector } from '@angular/core';
import { isFunction, isArray, isBlank } from '@asseco/common';
import { Observable, Subject, empty } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { AUTHENTICATION_SERVICE_OPTIONS } from './authenticationServiceOptions.interface';
import * as i0 from "@angular/core";
import * as i1 from "./authenticationServiceOptions.interface";
/**
 * Factory used for creating AuthenticationService
 * @param {?} options Options passed to created service
 * @return {?}
 */
export function authenticationServiceFactory(options) {
    if (isBlank(options) ||
        isBlank(options.getUserIdentity) || !isFunction(options.getUserIdentity) ||
        isBlank(options.login) || !isFunction(options.login) ||
        isBlank(options.logout) || !isFunction(options.logout) ||
        isBlank(options.isAuthPage) || !isFunction(options.isAuthPage) ||
        isBlank(options.showAccessDenied) || !isFunction(options.showAccessDenied) ||
        isBlank(options.showAuthPage) || !isFunction(options.showAuthPage)) {
        throw new Error("Options must be set and must implement AuthenticationServiceOptions");
    }
    return new AuthenticationService(options);
}
/**
 * Authentication service managing authentication
 * @template TUserInfo
 */
export class AuthenticationService {
    //######################### constructor #########################
    //TODO - report bug, this is HACK to be compilable
    /**
     * @param {?} _options
     */
    constructor(_options) {
        this._options = _options;
        /**
         * Subject used for indicating authenticationChanged
         */
        this._authenticationChangedSubject = new Subject();
        this.isInitialized = new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        resolve => this._isInitializedResolver = resolve));
    }
    /**
     * Gets observable that indicates when authentication has changed
     * @return {?}
     */
    get authenticationChanged() {
        return this._authenticationChangedSubject.asObservable();
    }
    //######################### public methods #########################
    /**
     * Tests whether is used authorized for specified permission
     * @param {?} permission Permission name that is tested
     * @return {?} Promise<boolean> True if user is authorized otherwise false
     */
    isAuthorized(permission) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.getUserIdentity()
                .then((/**
             * @param {?} userIdentity
             * @return {?}
             */
            (userIdentity) => {
                if (isArray(userIdentity.permissions)) {
                    if (userIdentity.permissions.indexOf(permission) > -1) {
                        resolve(true);
                    }
                    else {
                        resolve(false);
                    }
                }
                else {
                    resolve(false);
                }
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            error => reject(error)));
        }));
    }
    /**
     * Gets user identity
     * @param {?=} refresh
     * @return {?} Promise
     */
    getUserIdentity(refresh) {
        if (refresh === true) {
            this._authenticationPromise = null;
        }
        if (this._authenticationPromise != null) {
            return this._authenticationPromise;
        }
        this._authenticationPromise = new Promise((/**
         * @param {?} success
         * @param {?} reject
         * @return {?}
         */
        (success, reject) => {
            this._options
                .getUserIdentity()
                .pipe(catchError((/**
             * @param {?} error
             * @return {?}
             */
            error => {
                reject(error);
                this._isInitializedResolver(true);
                return empty();
            })))
                .subscribe((/**
             * @param {?} itm
             * @return {?}
             */
            (itm) => {
                success(itm);
                this._authenticationChangedSubject.next(itm);
                this._isInitializedResolver(true);
            }));
        }));
        return this._authenticationPromise;
    }
    /**
     * Method logs user into system
     * @param {?} accessToken Access token holding authentication information
     * @return {?} Observable
     */
    login(accessToken) {
        return Observable.create((/**
         * @param {?} observer
         * @return {?}
         */
        (observer) => {
            this._options.login(accessToken)
                .subscribe((/**
             * @return {?}
             */
            () => {
                this.getUserIdentity(true)
                    .then((/**
                 * @return {?}
                 */
                () => {
                    observer.next(null);
                }));
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                observer.error(error);
            }));
        }));
    }
    /**
     * Methods logs out user out of system
     * @return {?} Observable
     */
    logout() {
        return Observable.create((/**
         * @param {?} observer
         * @return {?}
         */
        (observer) => {
            this._options.logout()
                .subscribe((/**
             * @return {?}
             */
            () => {
                this.getUserIdentity(true)
                    .then((/**
                 * @return {?}
                 */
                () => {
                    observer.next(null);
                }));
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                observer.error(error);
            }));
        }));
    }
    /**
     * Redirects current page to authentication page
     * @return {?}
     */
    showAuthPage() {
        return this._options.showAuthPage();
    }
    /**
     * Redirects current page to access denied page
     * @return {?}
     */
    showAccessDenied() {
        return this._options.showAccessDenied();
    }
    /**
     * Gets indicatio whether current state of app is displaying login page
     * @return {?} boolean
     */
    isAuthPage() {
        return this._options.isAuthPage();
    }
}
AuthenticationService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root', deps: [AUTHENTICATION_SERVICE_OPTIONS], useFactory: authenticationServiceFactory },] }
];
/** @nocollapse */
AuthenticationService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [Injector,] }] }
];
/** @nocollapse */ AuthenticationService.ngInjectableDef = i0.defineInjectable({ factory: function AuthenticationService_Factory() { return authenticationServiceFactory(i0.inject(i1.AUTHENTICATION_SERVICE_OPTIONS)); }, token: AuthenticationService, providedIn: "root" });
if (false) {
    /**
     * Authentication promise that was used for authentication
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._authenticationPromise;
    /**
     * Resolved function for isInitialized
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._isInitializedResolver;
    /**
     * Subject used for indicating authenticationChanged
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._authenticationChangedSubject;
    /**
     * Indication whether is authentication module initialized or not
     * @type {?}
     */
    AuthenticationService.prototype.isInitialized;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tb24vYXV0aGVudGljYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzNELE9BQU8sRUFBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzVELE9BQU8sRUFBQyxVQUFVLEVBQVksT0FBTyxFQUFFLEtBQUssRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFHMUMsT0FBTyxFQUErQiw4QkFBOEIsRUFBQyxNQUFNLDBDQUEwQyxDQUFDOzs7Ozs7OztBQU90SCxNQUFNLFVBQVUsNEJBQTRCLENBQUMsT0FBMEM7SUFFbkYsSUFBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQztRQUN4RSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDcEQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3RELE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztRQUM5RCxPQUFPLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDO1FBQzFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUNyRTtRQUNJLE1BQU0sSUFBSSxLQUFLLENBQUMscUVBQXFFLENBQUMsQ0FBQztLQUMxRjtJQUVELE9BQU8sSUFBSSxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM5QyxDQUFDOzs7OztBQU1ELE1BQU0sT0FBTyxxQkFBcUI7Ozs7OztJQW9DOUIsWUFBc0MsUUFBaUQ7UUFBakQsYUFBUSxHQUFSLFFBQVEsQ0FBeUM7Ozs7UUFuQi9FLGtDQUE2QixHQUFxQyxJQUFJLE9BQU8sRUFBMkIsQ0FBQztRQXFCN0csSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLE9BQU87Ozs7UUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxPQUFPLEVBQUMsQ0FBQztJQUN2RixDQUFDOzs7OztJQVZELElBQVcscUJBQXFCO1FBRTVCLE9BQU8sSUFBSSxDQUFDLDZCQUE2QixDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzdELENBQUM7Ozs7Ozs7SUFnQk0sWUFBWSxDQUFDLFVBQWtCO1FBRWxDLE9BQU8sSUFBSSxPQUFPOzs7OztRQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBRW5DLElBQUksQ0FBQyxlQUFlLEVBQUU7aUJBQ2pCLElBQUk7Ozs7WUFBQyxDQUFDLFlBQXFDLEVBQUUsRUFBRTtnQkFFNUMsSUFBRyxPQUFPLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUNwQztvQkFDSSxJQUFHLFlBQVksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUNwRDt3QkFDSSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7cUJBQ2pCO3lCQUVEO3dCQUNJLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztxQkFDbEI7aUJBQ0o7cUJBRUQ7b0JBQ0ksT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUNsQjtZQUNMLENBQUMsRUFBQztpQkFDRCxLQUFLOzs7O1lBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUMsQ0FBQztRQUN2QyxDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Ozs7OztJQU9NLGVBQWUsQ0FBQyxPQUFpQjtRQUVwQyxJQUFHLE9BQU8sS0FBSyxJQUFJLEVBQ25CO1lBQ0ksSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQztTQUN0QztRQUVELElBQUcsSUFBSSxDQUFDLHNCQUFzQixJQUFJLElBQUksRUFDdEM7WUFDSSxPQUFPLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztTQUN0QztRQUVELElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLE9BQU87Ozs7O1FBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFFMUQsSUFBSSxDQUFDLFFBQVE7aUJBQ1IsZUFBZSxFQUFFO2lCQUNqQixJQUFJLENBQUMsVUFBVTs7OztZQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUVmLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDZCxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBRWxDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDbkIsQ0FBQyxFQUFDLENBQUM7aUJBQ1IsU0FBUzs7OztZQUFDLENBQUMsR0FBNEIsRUFBRSxFQUFFO2dCQUV4QyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2IsSUFBSSxDQUFDLDZCQUE2QixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDN0MsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RDLENBQUMsRUFBQyxDQUFDO1FBQ1gsQ0FBQyxFQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztJQUN2QyxDQUFDOzs7Ozs7SUFPTSxLQUFLLENBQUMsV0FBd0I7UUFFakMsT0FBTyxVQUFVLENBQUMsTUFBTTs7OztRQUFDLENBQUMsUUFBdUIsRUFBRSxFQUFFO1lBRWpELElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztpQkFDM0IsU0FBUzs7O1lBQUMsR0FBRyxFQUFFO2dCQUVaLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDO3FCQUNyQixJQUFJOzs7Z0JBQUMsR0FBRyxFQUFFO29CQUVQLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3hCLENBQUMsRUFBQyxDQUFDO1lBQ1gsQ0FBQzs7OztZQUFFLEtBQUssQ0FBQyxFQUFFO2dCQUVQLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDMUIsQ0FBQyxFQUFDLENBQUM7UUFDWCxDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Ozs7O0lBTU0sTUFBTTtRQUVULE9BQU8sVUFBVSxDQUFDLE1BQU07Ozs7UUFBQyxDQUFDLFFBQXVCLEVBQUUsRUFBRTtZQUVqRCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtpQkFDakIsU0FBUzs7O1lBQUMsR0FBRyxFQUFFO2dCQUVaLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDO3FCQUNyQixJQUFJOzs7Z0JBQUMsR0FBRyxFQUFFO29CQUVQLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3hCLENBQUMsRUFBQyxDQUFDO1lBQ1gsQ0FBQzs7OztZQUFFLEtBQUssQ0FBQyxFQUFFO2dCQUVQLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDMUIsQ0FBQyxFQUFDLENBQUM7UUFDWCxDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Ozs7O0lBS00sWUFBWTtRQUVmLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN4QyxDQUFDOzs7OztJQUtNLGdCQUFnQjtRQUVuQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUM1QyxDQUFDOzs7OztJQU1NLFVBQVU7UUFFYixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDdEMsQ0FBQzs7O1lBekxKLFVBQVUsU0FBQyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsOEJBQThCLENBQUMsRUFBRSxVQUFVLEVBQUUsNEJBQTRCLEVBQUM7Ozs7NENBcUNqRyxNQUFNLFNBQUMsUUFBUTs7Ozs7Ozs7O0lBN0I1Qix1REFBc0U7Ozs7OztJQUt0RSx1REFBOEQ7Ozs7OztJQUs5RCw4REFBaUg7Ozs7O0lBT2pILDhDQUF1Qzs7Ozs7SUFZM0IseUNBQTJFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlLCBJbmplY3QsIEluamVjdG9yfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtpc0Z1bmN0aW9uLCBpc0FycmF5LCBpc0JsYW5rfSBmcm9tICdAYXNzZWNvL2NvbW1vbic7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZSwgT2JzZXJ2ZXIsIFN1YmplY3QsIGVtcHR5fSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtjYXRjaEVycm9yfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQge1VzZXJJZGVudGl0eX0gZnJvbSAnLi91c2VySWRlbnRpdHknO1xyXG5pbXBvcnQge0F1dGhlbnRpY2F0aW9uU2VydmljZU9wdGlvbnMsIEFVVEhFTlRJQ0FUSU9OX1NFUlZJQ0VfT1BUSU9OU30gZnJvbSAnLi9hdXRoZW50aWNhdGlvblNlcnZpY2VPcHRpb25zLmludGVyZmFjZSc7XHJcbmltcG9ydCB7QWNjZXNzVG9rZW59IGZyb20gJy4vYWNjZXNzVG9rZW4nO1xyXG5cclxuLyoqXHJcbiAqIEZhY3RvcnkgdXNlZCBmb3IgY3JlYXRpbmcgQXV0aGVudGljYXRpb25TZXJ2aWNlXHJcbiAqIEBwYXJhbSBvcHRpb25zIE9wdGlvbnMgcGFzc2VkIHRvIGNyZWF0ZWQgc2VydmljZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGF1dGhlbnRpY2F0aW9uU2VydmljZUZhY3Rvcnkob3B0aW9uczogQXV0aGVudGljYXRpb25TZXJ2aWNlT3B0aW9uczxhbnk+KVxyXG57XHJcbiAgICBpZihpc0JsYW5rKG9wdGlvbnMpIHx8XHJcbiAgICAgICBpc0JsYW5rKG9wdGlvbnMuZ2V0VXNlcklkZW50aXR5KSB8fCAhaXNGdW5jdGlvbihvcHRpb25zLmdldFVzZXJJZGVudGl0eSkgfHxcclxuICAgICAgIGlzQmxhbmsob3B0aW9ucy5sb2dpbikgfHwgIWlzRnVuY3Rpb24ob3B0aW9ucy5sb2dpbikgfHxcclxuICAgICAgIGlzQmxhbmsob3B0aW9ucy5sb2dvdXQpIHx8ICFpc0Z1bmN0aW9uKG9wdGlvbnMubG9nb3V0KSB8fFxyXG4gICAgICAgaXNCbGFuayhvcHRpb25zLmlzQXV0aFBhZ2UpIHx8ICFpc0Z1bmN0aW9uKG9wdGlvbnMuaXNBdXRoUGFnZSkgfHxcclxuICAgICAgIGlzQmxhbmsob3B0aW9ucy5zaG93QWNjZXNzRGVuaWVkKSB8fCAhaXNGdW5jdGlvbihvcHRpb25zLnNob3dBY2Nlc3NEZW5pZWQpIHx8XHJcbiAgICAgICBpc0JsYW5rKG9wdGlvbnMuc2hvd0F1dGhQYWdlKSB8fCAhaXNGdW5jdGlvbihvcHRpb25zLnNob3dBdXRoUGFnZSkpXHJcbiAgICB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT3B0aW9ucyBtdXN0IGJlIHNldCBhbmQgbXVzdCBpbXBsZW1lbnQgQXV0aGVudGljYXRpb25TZXJ2aWNlT3B0aW9uc1wiKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbmV3IEF1dGhlbnRpY2F0aW9uU2VydmljZShvcHRpb25zKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEF1dGhlbnRpY2F0aW9uIHNlcnZpY2UgbWFuYWdpbmcgYXV0aGVudGljYXRpb25cclxuICovXHJcbkBJbmplY3RhYmxlKHtwcm92aWRlZEluOiAncm9vdCcsIGRlcHM6IFtBVVRIRU5USUNBVElPTl9TRVJWSUNFX09QVElPTlNdLCB1c2VGYWN0b3J5OiBhdXRoZW50aWNhdGlvblNlcnZpY2VGYWN0b3J5fSlcclxuZXhwb3J0IGNsYXNzIEF1dGhlbnRpY2F0aW9uU2VydmljZTxUVXNlckluZm8+XHJcbntcclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwcml2YXRlIGZpZWxkcyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBdXRoZW50aWNhdGlvbiBwcm9taXNlIHRoYXQgd2FzIHVzZWQgZm9yIGF1dGhlbnRpY2F0aW9uXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2F1dGhlbnRpY2F0aW9uUHJvbWlzZTogUHJvbWlzZTxVc2VySWRlbnRpdHk8VFVzZXJJbmZvPj58bnVsbDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlc29sdmVkIGZ1bmN0aW9uIGZvciBpc0luaXRpYWxpemVkXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2lzSW5pdGlhbGl6ZWRSZXNvbHZlcjogKGluZGljYXRpb246IGJvb2xlYW4pID0+IHZvaWQ7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTdWJqZWN0IHVzZWQgZm9yIGluZGljYXRpbmcgYXV0aGVudGljYXRpb25DaGFuZ2VkXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2F1dGhlbnRpY2F0aW9uQ2hhbmdlZFN1YmplY3Q6IFN1YmplY3Q8VXNlcklkZW50aXR5PFRVc2VySW5mbz4+ID0gbmV3IFN1YmplY3Q8VXNlcklkZW50aXR5PFRVc2VySW5mbz4+KCk7XHJcblxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHB1YmxpYyBwcm9wZXJ0aWVzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIEluZGljYXRpb24gd2hldGhlciBpcyBhdXRoZW50aWNhdGlvbiBtb2R1bGUgaW5pdGlhbGl6ZWQgb3Igbm90XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBpc0luaXRpYWxpemVkOiBQcm9taXNlPGJvb2xlYW4+O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyBvYnNlcnZhYmxlIHRoYXQgaW5kaWNhdGVzIHdoZW4gYXV0aGVudGljYXRpb24gaGFzIGNoYW5nZWRcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldCBhdXRoZW50aWNhdGlvbkNoYW5nZWQoKTogT2JzZXJ2YWJsZTxVc2VySWRlbnRpdHk8VFVzZXJJbmZvPj5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fYXV0aGVudGljYXRpb25DaGFuZ2VkU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgY29uc3RydWN0b3IgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG4gICAgLy9UT0RPIC0gcmVwb3J0IGJ1ZywgdGhpcyBpcyBIQUNLIHRvIGJlIGNvbXBpbGFibGVcclxuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoSW5qZWN0b3IpIHByaXZhdGUgX29wdGlvbnM6IEF1dGhlbnRpY2F0aW9uU2VydmljZU9wdGlvbnM8VFVzZXJJbmZvPilcclxuICAgIHtcclxuICAgICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHRoaXMuX2lzSW5pdGlhbGl6ZWRSZXNvbHZlciA9IHJlc29sdmUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwdWJsaWMgbWV0aG9kcyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUZXN0cyB3aGV0aGVyIGlzIHVzZWQgYXV0aG9yaXplZCBmb3Igc3BlY2lmaWVkIHBlcm1pc3Npb25cclxuICAgICAqIEBwYXJhbSBwZXJtaXNzaW9uIFBlcm1pc3Npb24gbmFtZSB0aGF0IGlzIHRlc3RlZFxyXG4gICAgICogQHJldHVybnMgUHJvbWlzZTxib29sZWFuPiBUcnVlIGlmIHVzZXIgaXMgYXV0aG9yaXplZCBvdGhlcndpc2UgZmFsc2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIGlzQXV0aG9yaXplZChwZXJtaXNzaW9uOiBzdHJpbmcpIDogUHJvbWlzZTxib29sZWFuPlxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PlxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5nZXRVc2VySWRlbnRpdHkoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHVzZXJJZGVudGl0eTogVXNlcklkZW50aXR5PFRVc2VySW5mbz4pID0+XHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoaXNBcnJheSh1c2VySWRlbnRpdHkucGVybWlzc2lvbnMpKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYodXNlcklkZW50aXR5LnBlcm1pc3Npb25zLmluZGV4T2YocGVybWlzc2lvbikgPiAtMSlcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gcmVqZWN0KGVycm9yKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXRzIHVzZXIgaWRlbnRpdHlcclxuICAgICAqIEBwYXJhbSByZWZyZXNoPyBJbmRpY2F0aW9uIHRoYXQgc2VydmVyIGdldCB1c2VyIGlkZW50aXR5IHNob3VsZCBiZSBjYWxsZWQsIG90aGVyd2lzZSBjYWNoZWQgcmVzcG9uc2Ugd2lsbCBiZSB1c2VkXHJcbiAgICAgKiBAcmV0dXJucyBQcm9taXNlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXRVc2VySWRlbnRpdHkocmVmcmVzaD86IGJvb2xlYW4pOiBQcm9taXNlPFVzZXJJZGVudGl0eTxUVXNlckluZm8+PlxyXG4gICAge1xyXG4gICAgICAgIGlmKHJlZnJlc2ggPT09IHRydWUpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLl9hdXRoZW50aWNhdGlvblByb21pc2UgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYodGhpcy5fYXV0aGVudGljYXRpb25Qcm9taXNlICE9IG51bGwpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fYXV0aGVudGljYXRpb25Qcm9taXNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fYXV0aGVudGljYXRpb25Qcm9taXNlID0gbmV3IFByb21pc2UoKHN1Y2Nlc3MsIHJlamVjdCkgPT5cclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnNcclxuICAgICAgICAgICAgICAgIC5nZXRVc2VySWRlbnRpdHkoKVxyXG4gICAgICAgICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcihlcnJvciA9PlxyXG4gICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faXNJbml0aWFsaXplZFJlc29sdmVyKHRydWUpO1xyXG4gIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChpdG06IFVzZXJJZGVudGl0eTxUVXNlckluZm8+KSA9PlxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoaXRtKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdXRoZW50aWNhdGlvbkNoYW5nZWRTdWJqZWN0Lm5leHQoaXRtKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9pc0luaXRpYWxpemVkUmVzb2x2ZXIodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2F1dGhlbnRpY2F0aW9uUHJvbWlzZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIE1ldGhvZCBsb2dzIHVzZXIgaW50byBzeXN0ZW1cclxuICAgICAqIEBwYXJhbSBhY2Nlc3NUb2tlbiBBY2Nlc3MgdG9rZW4gaG9sZGluZyBhdXRoZW50aWNhdGlvbiBpbmZvcm1hdGlvblxyXG4gICAgICogQHJldHVybnMgT2JzZXJ2YWJsZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgbG9naW4oYWNjZXNzVG9rZW46IEFjY2Vzc1Rva2VuKTogT2JzZXJ2YWJsZTxhbnk+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogT2JzZXJ2ZXI8YW55PikgPT5cclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnMubG9naW4oYWNjZXNzVG9rZW4pXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+XHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRVc2VySWRlbnRpdHkodHJ1ZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9LCBlcnJvciA9PlxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTWV0aG9kcyBsb2dzIG91dCB1c2VyIG91dCBvZiBzeXN0ZW1cclxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGxvZ291dCgpOiBPYnNlcnZhYmxlPGFueT5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBPYnNlcnZlcjxhbnk+KSA9PlxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fb3B0aW9ucy5sb2dvdXQoKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PlxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0VXNlcklkZW50aXR5KHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSwgZXJyb3IgPT5cclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlZGlyZWN0cyBjdXJyZW50IHBhZ2UgdG8gYXV0aGVudGljYXRpb24gcGFnZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2hvd0F1dGhQYWdlKCk6IFByb21pc2U8Ym9vbGVhbj5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fb3B0aW9ucy5zaG93QXV0aFBhZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlZGlyZWN0cyBjdXJyZW50IHBhZ2UgdG8gYWNjZXNzIGRlbmllZCBwYWdlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzaG93QWNjZXNzRGVuaWVkKCk6IFByb21pc2U8Ym9vbGVhbj5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fb3B0aW9ucy5zaG93QWNjZXNzRGVuaWVkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXRzIGluZGljYXRpbyB3aGV0aGVyIGN1cnJlbnQgc3RhdGUgb2YgYXBwIGlzIGRpc3BsYXlpbmcgbG9naW4gcGFnZVxyXG4gICAgICogQHJldHVybnMgYm9vbGVhblxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaXNBdXRoUGFnZSgpOiBib29sZWFuXHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX29wdGlvbnMuaXNBdXRoUGFnZSgpO1xyXG4gICAgfVxyXG59Il19