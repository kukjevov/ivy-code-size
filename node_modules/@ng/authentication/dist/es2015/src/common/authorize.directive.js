/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, TemplateRef, ViewContainerRef, Input, ChangeDetectorRef } from '@angular/core';
import { isString, isBoolean, isBlank } from '@asseco/common';
import { AuthenticationService } from './authentication.service';
export class AuthorizeDirective {
    //######################### constructor #########################
    /**
     * @param {?} _template
     * @param {?} _viewContainer
     * @param {?} _authService
     * @param {?} _changeDetector
     */
    constructor(_template, _viewContainer, _authService, _changeDetector) {
        this._template = _template;
        this._viewContainer = _viewContainer;
        this._authService = _authService;
        this._changeDetector = _changeDetector;
        //######################### private fields #########################
        /**
         * Subscription for changes in authentication
         */
        this._subscription = null;
        /**
         * Indication that AND condition should be used instead of OR condition if multiple permissions are provided
         */
        this.andCondition = false;
        /**
         * Indication that provided string is set of loggical operations among permission names, if this is true andCondition is ignored
         */
        this.conditionString = false;
    }
    //######################### public methods - implementation of OnInit #########################
    /**
     * Initialize component
     * @return {?}
     */
    ngOnInit() {
        if (isBlank(this.permission)) {
            throw new Error("You must specify 'authorize' attribute value.");
        }
        if (!isBoolean(this.andCondition)) {
            throw new Error("Parameter 'andCondition' must be boolean value!");
        }
        if (!isBoolean(this.conditionString)) {
            throw new Error("Parameter 'conditionString' must be boolean value!");
        }
        if (isString(this.permission) && this.permission.indexOf(",") > -1) {
            this.permission = this.permission.split(",").map((/**
             * @param {?} itm
             * @return {?}
             */
            itm => itm.trim()));
        }
        this._authService
            .getUserIdentity()
            .then((/**
         * @param {?} userIdentity
         * @return {?}
         */
        userIdentity => {
            this._renderIfPermission(userIdentity);
            this._changeDetector.detectChanges();
        }));
        this._subscription = this._authService
            .authenticationChanged
            .subscribe((/**
         * @param {?} userIdentity
         * @return {?}
         */
        userIdentity => {
            this._renderIfPermission(userIdentity);
            this._changeDetector.detectChanges();
        }), (/**
         * @return {?}
         */
        () => { }));
    }
    //######################### public methods - implementation of OnDestroy #########################
    /**
     * Called when component is destroyed
     * @return {?}
     */
    ngOnDestroy() {
        if (this._subscription) {
            this._subscription.unsubscribe();
            this._subscription = null;
        }
    }
    //######################### private methods #########################
    /**
     * Renders content if user has permissions
     * @private
     * @param {?} userIdentity
     * @return {?}
     */
    _renderIfPermission(userIdentity) {
        if (!isString(this.permission) && !Array.isArray(this.permission)) {
            throw new Error("Invalid argument type! Permission must be string or array of strings.");
        }
        if (userIdentity) {
            this._viewContainer.clear();
            //Multiple conditions
            if (Array.isArray(this.permission)) {
                /** @type {?} */
                let arrayPermission = (/** @type {?} */ (this.permission));
                if (this.andCondition) {
                    //AND Condition
                    if (arrayPermission.map((/**
                     * @param {?} perm
                     * @return {?}
                     */
                    perm => userIdentity.permissions.indexOf(perm) > -1)).every((/**
                     * @param {?} itm
                     * @return {?}
                     */
                    itm => itm === true))) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
                else {
                    //OR Condition
                    if (arrayPermission.map((/**
                     * @param {?} perm
                     * @return {?}
                     */
                    perm => userIdentity.permissions.indexOf(perm) > -1)).indexOf(true) > -1) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
            }
            //Single condition
            else {
                //Condition string
                if (this.conditionString) {
                    //TODO - think of some optimization for performance reasons
                    /** @type {?} */
                    let condition = (/** @type {?} */ (this.permission));
                    condition.replace(/!?(.*?)(?:&+|\|+|\(|\)|$)/g, "$1")
                        .split(" ")
                        .filter((/**
                     * @param {?} itm
                     * @return {?}
                     */
                    function (itm) { return itm.trim(); }))
                        .forEach((/**
                     * @param {?} permissionName
                     * @return {?}
                     */
                    permissionName => condition = condition.replace(new RegExp(permissionName, 'g'), (userIdentity.permissions.indexOf(permissionName) > -1).toString())));
                    if (new Function(`return (${condition})`)()) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
                //Permission name string
                else {
                    /** @type {?} */
                    let stringPermission = (/** @type {?} */ (this.permission));
                    if (userIdentity.permissions.indexOf(stringPermission) > -1) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
            }
        }
    }
}
AuthorizeDirective.decorators = [
    { type: Directive, args: [{
                selector: "[authorize]"
            },] }
];
/** @nocollapse */
AuthorizeDirective.ctorParameters = () => [
    { type: TemplateRef },
    { type: ViewContainerRef },
    { type: AuthenticationService },
    { type: ChangeDetectorRef }
];
AuthorizeDirective.propDecorators = {
    permission: [{ type: Input, args: ["authorize",] }],
    andCondition: [{ type: Input, args: ["authorizeAndCondition",] }],
    conditionString: [{ type: Input, args: ["authorizeConditionString",] }]
};
if (false) {
    /**
     * Subscription for changes in authentication
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._subscription;
    /**
     * Name of permission that is requested for displaying element
     * @type {?}
     */
    AuthorizeDirective.prototype.permission;
    /**
     * Indication that AND condition should be used instead of OR condition if multiple permissions are provided
     * @type {?}
     */
    AuthorizeDirective.prototype.andCondition;
    /**
     * Indication that provided string is set of loggical operations among permission names, if this is true andCondition is ignored
     * @type {?}
     */
    AuthorizeDirective.prototype.conditionString;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._template;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._viewContainer;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._authService;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._changeDetector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aG9yaXplLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tb24vYXV0aG9yaXplLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQVUsS0FBSyxFQUFhLGlCQUFpQixFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3BILE9BQU8sRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRzVELE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBTy9ELE1BQU0sT0FBTyxrQkFBa0I7Ozs7Ozs7O0lBOEIzQixZQUFvQixTQUEyQixFQUMzQixjQUFnQyxFQUNoQyxZQUF3QyxFQUN4QyxlQUFrQztRQUhsQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixtQkFBYyxHQUFkLGNBQWMsQ0FBa0I7UUFDaEMsaUJBQVksR0FBWixZQUFZLENBQTRCO1FBQ3hDLG9CQUFlLEdBQWYsZUFBZSxDQUFtQjs7Ozs7UUExQjlDLGtCQUFhLEdBQXNCLElBQUksQ0FBQzs7OztRQWN6QyxpQkFBWSxHQUFZLEtBQUssQ0FBQzs7OztRQU05QixvQkFBZSxHQUFZLEtBQUssQ0FBQztJQVF4QyxDQUFDOzs7Ozs7SUFPTSxRQUFRO1FBRVgsSUFBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUMzQjtZQUNJLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztTQUNwRTtRQUVELElBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUNoQztZQUNJLE1BQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztTQUN0RTtRQUVELElBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUNuQztZ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QUFDLFdBQVc7MkJBTWpCLEtBQUssU0FBQyx1QkFBdUI7OEJBTTdCLEtBQUssU0FBQywwQkFBMEI7Ozs7Ozs7O0lBbkJqQywyQ0FBZ0Q7Ozs7O0lBT2hELHdDQUNxQzs7Ozs7SUFLckMsMENBQ3FDOzs7OztJQUtyQyw2Q0FDd0M7Ozs7O0lBRzVCLHVDQUFtQzs7Ozs7SUFDbkMsNENBQXdDOzs7OztJQUN4QywwQ0FBZ0Q7Ozs7O0lBQ2hELDZDQUEwQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGlyZWN0aXZlLCBUZW1wbGF0ZVJlZiwgVmlld0NvbnRhaW5lclJlZiwgT25Jbml0LCBJbnB1dCwgT25EZXN0cm95LCBDaGFuZ2VEZXRlY3RvclJlZn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7aXNTdHJpbmcsIGlzQm9vbGVhbiwgaXNCbGFua30gZnJvbSAnQGFzc2Vjby9jb21tb24nO1xyXG5pbXBvcnQge1N1YnNjcmlwdGlvbn0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQge0F1dGhlbnRpY2F0aW9uU2VydmljZX0gZnJvbSAnLi9hdXRoZW50aWNhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHtVc2VySWRlbnRpdHl9IGZyb20gJy4vdXNlcklkZW50aXR5JztcclxuXHJcbkBEaXJlY3RpdmUoXHJcbntcclxuICAgIHNlbGVjdG9yOiBcIlthdXRob3JpemVdXCJcclxufSlcclxuZXhwb3J0IGNsYXNzIEF1dGhvcml6ZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95XHJcbntcclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwcml2YXRlIGZpZWxkcyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTdWJzY3JpcHRpb24gZm9yIGNoYW5nZXMgaW4gYXV0aGVudGljYXRpb25cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb258bnVsbCA9IG51bGw7XHJcblxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHB1YmxpYyBwcm9wZXJ0aWVzIC0gaW5wdXRzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIE5hbWUgb2YgcGVybWlzc2lvbiB0aGF0IGlzIHJlcXVlc3RlZCBmb3IgZGlzcGxheWluZyBlbGVtZW50XHJcbiAgICAgKi9cclxuICAgIEBJbnB1dChcImF1dGhvcml6ZVwiKVxyXG4gICAgcHVibGljIHBlcm1pc3Npb246IHN0cmluZyB8IHN0cmluZ1tdO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5kaWNhdGlvbiB0aGF0IEFORCBjb25kaXRpb24gc2hvdWxkIGJlIHVzZWQgaW5zdGVhZCBvZiBPUiBjb25kaXRpb24gaWYgbXVsdGlwbGUgcGVybWlzc2lvbnMgYXJlIHByb3ZpZGVkXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dChcImF1dGhvcml6ZUFuZENvbmRpdGlvblwiKVxyXG4gICAgcHVibGljIGFuZENvbmRpdGlvbjogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5kaWNhdGlvbiB0aGF0IHByb3ZpZGVkIHN0cmluZyBpcyBzZXQgb2YgbG9nZ2ljYWwgb3BlcmF0aW9ucyBhbW9uZyBwZXJtaXNzaW9uIG5hbWVzLCBpZiB0aGlzIGlzIHRydWUgYW5kQ29uZGl0aW9uIGlzIGlnbm9yZWRcclxuICAgICAqL1xyXG4gICAgQElucHV0KFwiYXV0aG9yaXplQ29uZGl0aW9uU3RyaW5nXCIpXHJcbiAgICBwdWJsaWMgY29uZGl0aW9uU3RyaW5nOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBcclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBjb25zdHJ1Y3RvciAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF90ZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgX3ZpZXdDb250YWluZXI6IFZpZXdDb250YWluZXJSZWYsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIF9hdXRoU2VydmljZTogQXV0aGVudGljYXRpb25TZXJ2aWNlPGFueT4sXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIF9jaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYpXHJcbiAgICB7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHB1YmxpYyBtZXRob2RzIC0gaW1wbGVtZW50YXRpb24gb2YgT25Jbml0ICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIEluaXRpYWxpemUgY29tcG9uZW50XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBuZ09uSW5pdCgpXHJcbiAgICB7XHJcbiAgICAgICAgaWYoaXNCbGFuayh0aGlzLnBlcm1pc3Npb24pKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiWW91IG11c3Qgc3BlY2lmeSAnYXV0aG9yaXplJyBhdHRyaWJ1dGUgdmFsdWUuXCIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYoIWlzQm9vbGVhbih0aGlzLmFuZENvbmRpdGlvbikpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQYXJhbWV0ZXIgJ2FuZENvbmRpdGlvbicgbXVzdCBiZSBib29sZWFuIHZhbHVlIVwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKCFpc0Jvb2xlYW4odGhpcy5jb25kaXRpb25TdHJpbmcpKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGFyYW1ldGVyICdjb25kaXRpb25TdHJpbmcnIG11c3QgYmUgYm9vbGVhbiB2YWx1ZSFcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZihpc1N0cmluZyh0aGlzLnBlcm1pc3Npb24pICYmIHRoaXMucGVybWlzc2lvbi5pbmRleE9mKFwiLFwiKSA+IC0xKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uID0gdGhpcy5wZXJtaXNzaW9uLnNwbGl0KFwiLFwiKS5tYXAoaXRtID0+IGl0bS50cmltKCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fYXV0aFNlcnZpY2VcclxuICAgICAgICAgICAgLmdldFVzZXJJZGVudGl0eSgpXHJcbiAgICAgICAgICAgIC50aGVuKHVzZXJJZGVudGl0eSA9PlxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJJZlBlcm1pc3Npb24odXNlcklkZW50aXR5KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbiA9IHRoaXMuX2F1dGhTZXJ2aWNlXHJcbiAgICAgICAgICAgIC5hdXRoZW50aWNhdGlvbkNoYW5nZWRcclxuICAgICAgICAgICAgLnN1YnNjcmliZSh1c2VySWRlbnRpdHkgPT5cclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVySWZQZXJtaXNzaW9uKHVzZXJJZGVudGl0eSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgIH0sICgpID0+IHt9KTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHB1YmxpYyBtZXRob2RzIC0gaW1wbGVtZW50YXRpb24gb2YgT25EZXN0cm95ICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuICAgIFxyXG4gICAgLyoqXHJcbiAgICAgKiBDYWxsZWQgd2hlbiBjb21wb25lbnQgaXMgZGVzdHJveWVkXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBuZ09uRGVzdHJveSgpXHJcbiAgICB7XHJcbiAgICAgICAgaWYodGhpcy5fc3Vic2NyaXB0aW9uKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwcml2YXRlIG1ldGhvZHMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVuZGVycyBjb250ZW50IGlmIHVzZXIgaGFzIHBlcm1pc3Npb25zXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3JlbmRlcklmUGVybWlzc2lvbih1c2VySWRlbnRpdHk6IFVzZXJJZGVudGl0eTxhbnk+KVxyXG4gICAge1xyXG4gICAgICAgIGlmKCFpc1N0cmluZyh0aGlzLnBlcm1pc3Npb24pICYmICFBcnJheS5pc0FycmF5KHRoaXMucGVybWlzc2lvbikpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGFyZ3VtZW50IHR5cGUhIFBlcm1pc3Npb24gbXVzdCBiZSBzdHJpbmcgb3IgYXJyYXkgb2Ygc3RyaW5ncy5cIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZih1c2VySWRlbnRpdHkpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLl92aWV3Q29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgICAgIC8vTXVsdGlwbGUgY29uZGl0aW9uc1xyXG4gICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHRoaXMucGVybWlzc2lvbikpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGxldCBhcnJheVBlcm1pc3Npb246IHN0cmluZ1tdID0gPHN0cmluZ1tdPnRoaXMucGVybWlzc2lvbjtcclxuXHJcbiAgICAgICAgICAgICAgICBpZih0aGlzLmFuZENvbmRpdGlvbilcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAvL0FORCBDb25kaXRpb25cclxuICAgICAgICAgICAgICAgICAgICBpZihhcnJheVBlcm1pc3Npb24ubWFwKHBlcm0gPT4gdXNlcklkZW50aXR5LnBlcm1pc3Npb25zLmluZGV4T2YocGVybSkgPiAtMSkuZXZlcnkoaXRtID0+IGl0bSA9PT0gdHJ1ZSkpXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92aWV3Q29udGFpbmVyLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLl90ZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vT1IgQ29uZGl0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoYXJyYXlQZXJtaXNzaW9uLm1hcChwZXJtID0+IHVzZXJJZGVudGl0eS5wZXJtaXNzaW9ucy5pbmRleE9mKHBlcm0pID4gLTEpLmluZGV4T2YodHJ1ZSkgPiAtMSlcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuX3RlbXBsYXRlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy9TaW5nbGUgY29uZGl0aW9uXHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgLy9Db25kaXRpb24gc3RyaW5nXHJcbiAgICAgICAgICAgICAgICBpZih0aGlzLmNvbmRpdGlvblN0cmluZylcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAvL1RPRE8gLSB0aGluayBvZiBzb21lIG9wdGltaXphdGlvbiBmb3IgcGVyZm9ybWFuY2UgcmVhc29uc1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjb25kaXRpb246IHN0cmluZyA9IDxzdHJpbmc+dGhpcy5wZXJtaXNzaW9uO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5yZXBsYWNlKC8hPyguKj8pKD86Jit8XFx8K3xcXCh8XFwpfCQpL2csIFwiJDFcIilcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnNwbGl0KFwiIFwiKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uKGl0bSl7cmV0dXJuIGl0bS50cmltKCl9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZm9yRWFjaChwZXJtaXNzaW9uTmFtZSA9PiBjb25kaXRpb24gPSBjb25kaXRpb24ucmVwbGFjZShuZXcgUmVnRXhwKHBlcm1pc3Npb25OYW1lLCAnZycpLCAodXNlcklkZW50aXR5LnBlcm1pc3Npb25zLmluZGV4T2YocGVybWlzc2lvbk5hbWUpID4gLTEpLnRvU3RyaW5nKCkpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYobmV3IEZ1bmN0aW9uKGByZXR1cm4gKCR7Y29uZGl0aW9ufSlgKSgpKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmlld0NvbnRhaW5lci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5fdGVtcGxhdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vUGVybWlzc2lvbiBuYW1lIHN0cmluZ1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdHJpbmdQZXJtaXNzaW9uOiBzdHJpbmcgPSA8c3RyaW5nPnRoaXMucGVybWlzc2lvbjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYodXNlcklkZW50aXR5LnBlcm1pc3Npb25zLmluZGV4T2Yoc3RyaW5nUGVybWlzc2lvbikgPiAtMSlcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuX3RlbXBsYXRlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=