var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { InjectionToken, Injector } from '@angular/core';
import { HTTP_INTERCEPTORS } from '@angular/common/http';
import { isBlank } from '@asseco/common';
import { IgnoredInterceptorsService } from '@ng/common';
import { Observable } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
/**
 * Configuration object that is used by AuthInterceptor, overriding its properties allows you to customize configuration
 * @abstract
 */
export class AuthInterceptorConfig {
}
if (false) {
    /**
     * Gets indication whether is user authenticated or not
     * @abstract
     * @return {?} boolean
     */
    AuthInterceptorConfig.prototype.isAuthenticated = function () { };
    /**
     * Gets indication whether request was done from authentication page
     * @abstract
     * @return {?} boolean
     */
    AuthInterceptorConfig.prototype.isAuthPage = function () { };
    /**
     * Redirects current page to authentication page
     * @abstract
     * @return {?}
     */
    AuthInterceptorConfig.prototype.showAuthPage = function () { };
    /**
     * Redirects current page to access denied page
     * @abstract
     * @return {?}
     */
    AuthInterceptorConfig.prototype.showAccessDenied = function () { };
}
/**
 * Token used for injecting custom configuration for AuthInterceptor
 * @type {?}
 */
export const AUTH_INTERCEPTOR_CONFIG = new InjectionToken("auth-interceptor-config");
/**
 * AuthInterceptor used for intercepting http responses and handling 401, 403 statuses
 */
export class AuthInterceptor {
    //######################### constructors #########################
    /**
     * @param {?} _config
     * @param {?} _ignoredInterceptorsService
     */
    constructor(_config, _ignoredInterceptorsService) {
        this._config = _config;
        this._ignoredInterceptorsService = _ignoredInterceptorsService;
        //######################### private fields #########################
        /**
         * Counter for requests in progress
         */
        this._requestsInProgress = 0;
        /**
         * Indication whether is handling of 401, 403 blocked because one request is already handled
         */
        this._blocked = false;
    }
    //######################### private properties #########################
    /**
     * Counter for requests in progress
     * @private
     * @param {?} value
     * @return {?}
     */
    set requestsInProgress(value) {
        this._requestsInProgress = value;
        if (value < 1) {
            this._blocked = false;
            this._requestsInProgress = 0;
        }
    }
    /**
     * @private
     * @return {?}
     */
    get requestsInProgress() {
        return this._requestsInProgress;
    }
    //######################### public methods - implementation of HttpInterceptor #########################
    /**
     * Intercepts http request
     * @param {?} req Request to be intercepted
     * @param {?} next Next middleware that can be called for next processing
     * @return {?}
     */
    intercept(req, next) {
        this.requestsInProgress++;
        return next.handle(req).pipe(catchError((/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            return (/** @type {?} */ (Observable.create((/**
             * @param {?} observer
             * @return {?}
             */
            (observer) => {
                //client error, not response from server, or is ignored
                if (err.error instanceof Error ||
                    (this._ignoredInterceptorsService && this._ignoredInterceptorsService.isIgnored(AuthInterceptor, req))) {
                    observer.error(err);
                    observer.complete();
                    return;
                }
                //if auth error
                if (err.status == 403 || err.status == 401) {
                    if (this._blocked) {
                        observer.error(err);
                        observer.complete();
                        return;
                    }
                    this._blocked = true;
                    //auth error from auth page
                    if (this._config.isAuthPage()) {
                        observer.error(err);
                        observer.complete();
                        return;
                    }
                    //auth error from other pages
                    this._config.isAuthenticated()
                        .then((/**
                     * @param {?} isAuthenticated
                     * @return {?}
                     */
                    (isAuthenticated) => __awaiter(this, void 0, void 0, function* () {
                        //access denied user authenticated, not authorized
                        if (isAuthenticated) {
                            yield this._config.showAccessDenied();
                            observer.complete();
                            return;
                        }
                        //show auth page, user not authenticated
                        yield this._config.showAuthPage();
                        observer.complete();
                        return;
                    })))
                        .catch((/**
                     * @return {?}
                     */
                    () => observer.complete()));
                    return;
                }
                //other errors
                observer.error(err);
                observer.complete();
            }))));
        })), tap((/**
         * @return {?}
         */
        () => this.requestsInProgress--), (/**
         * @return {?}
         */
        () => this.requestsInProgress--)));
    }
}
if (false) {
    /**
     * Counter for requests in progress
     * @type {?}
     * @private
     */
    AuthInterceptor.prototype._requestsInProgress;
    /**
     * Indication whether is handling of 401, 403 blocked because one request is already handled
     * @type {?}
     * @private
     */
    AuthInterceptor.prototype._blocked;
    /**
     * @type {?}
     * @private
     */
    AuthInterceptor.prototype._config;
    /**
     * @type {?}
     * @private
     */
    AuthInterceptor.prototype._ignoredInterceptorsService;
}
/**
 * Factory used for creating auth interceptor
 * @param {?} config Configuration for auth interceptor
 * @param {?} injector
 * @return {?}
 */
export function authInterceptorProviderFactory(config, injector) {
    if (isBlank(config) || !(config instanceof AuthInterceptorConfig)) {
        throw new Error("Provided configuration for 'AuthInterceptor' is not of type 'AutInterceptorConfig', you must provide one!");
    }
    return new AuthInterceptor(config, injector.get(IgnoredInterceptorsService));
}
;
/**
 * Provider for proper use of AuthInterceptor, use this provider to inject this interceptor
 * @type {?}
 */
export const AUTH_INTERCEPTOR_PROVIDER = {
    provide: HTTP_INTERCEPTORS,
    multi: true,
    useFactory: authInterceptorProviderFactory,
    deps: [AUTH_INTERCEPTOR_CONFIG, Injector]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aEludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2F1dGhJbnRlcmNlcHRvci9hdXRoSW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFrQixjQUFjLEVBQUUsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3hFLE9BQU8sRUFBa0IsaUJBQWlCLEVBQXlCLE1BQU0sc0JBQXNCLENBQUM7QUFDaEcsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBQywwQkFBMEIsRUFBa0MsTUFBTSxZQUFZLENBQUM7QUFDdkYsT0FBTyxFQUFDLFVBQVUsRUFBNEIsTUFBTSxNQUFNLENBQUM7QUFDM0QsT0FBTyxFQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7QUFLL0MsTUFBTSxPQUFnQixxQkFBcUI7Q0F1QjFDOzs7Ozs7O0lBakJHLGtFQUE2Qzs7Ozs7O0lBTTdDLDZEQUErQjs7Ozs7O0lBSy9CLCtEQUEwQzs7Ozs7O0lBSzFDLG1FQUE4Qzs7Ozs7O0FBTWxELE1BQU0sT0FBTyx1QkFBdUIsR0FBMEMsSUFBSSxjQUFjLENBQXdCLHlCQUF5QixDQUFDOzs7O0FBS2xKLE1BQU0sT0FBTyxlQUFlOzs7Ozs7SUFtQ3hCLFlBQW9CLE9BQThCLEVBQzlCLDJCQUF1RDtRQUR2RCxZQUFPLEdBQVAsT0FBTyxDQUF1QjtRQUM5QixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTRCOzs7OztRQTdCbkUsd0JBQW1CLEdBQVcsQ0FBQyxDQUFDOzs7O1FBS2hDLGFBQVEsR0FBWSxLQUFLLENBQUM7SUEwQmxDLENBQUM7Ozs7Ozs7O0lBbkJELElBQVksa0JBQWtCLENBQUMsS0FBYTtRQUV4QyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsS0FBSyxDQUFDO1FBRWpDLElBQUcsS0FBSyxHQUFHLENBQUMs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OEJBQThCLENBQUMsTUFBNkIsRUFBRSxRQUFrQjtJQUU1RixJQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxZQUFZLHFCQUFxQixDQUFDLEVBQ2hFO1FBQ0ksTUFBTSxJQUFJLEtBQUssQ0FBQywyR0FBMkcsQ0FBQyxDQUFDO0tBQ2hJO0lBRUQsT0FBTyxJQUFJLGVBQWUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUM7QUFDakYsQ0FBQztBQUFBLENBQUM7Ozs7O0FBS0YsTUFBTSxPQUFPLHlCQUF5QixHQUN0QztJQUNJLE9BQU8sRUFBRSxpQkFBaUI7SUFDMUIsS0FBSyxFQUFFLElBQUk7SUFDWCxVQUFVLEVBQUUsOEJBQThCO0lBQzFDLElBQUksRUFBRSxDQUFDLHVCQUF1QixFQUFFLFFBQVEsQ0FBQztDQUM1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RmFjdG9yeVByb3ZpZGVyLCBJbmplY3Rpb25Ub2tlbiwgSW5qZWN0b3J9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge0h0dHBJbnRlcmNlcHRvciwgSFRUUF9JTlRFUkNFUFRPUlMsIEh0dHBFdmVudCwgSHR0cEhhbmRsZXJ9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHtpc0JsYW5rfSBmcm9tICdAYXNzZWNvL2NvbW1vbic7XHJcbmltcG9ydCB7SWdub3JlZEludGVyY2VwdG9yc1NlcnZpY2UsIEh0dHBSZXF1ZXN0SWdub3JlZEludGVyY2VwdG9ySWR9IGZyb20gJ0BuZy9jb21tb24nO1xyXG5pbXBvcnQge09ic2VydmFibGUsIE9ic2VydmFibGVJbnB1dCwgT2JzZXJ2ZXJ9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge2NhdGNoRXJyb3IsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuLyoqXHJcbiAqIENvbmZpZ3VyYXRpb24gb2JqZWN0IHRoYXQgaXMgdXNlZCBieSBBdXRoSW50ZXJjZXB0b3IsIG92ZXJyaWRpbmcgaXRzIHByb3BlcnRpZXMgYWxsb3dzIHlvdSB0byBjdXN0b21pemUgY29uZmlndXJhdGlvblxyXG4gKi9cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEF1dGhJbnRlcmNlcHRvckNvbmZpZ1xyXG57XHJcbiAgICAvKipcclxuICAgICAqIEdldHMgaW5kaWNhdGlvbiB3aGV0aGVyIGlzIHVzZXIgYXV0aGVudGljYXRlZCBvciBub3RcclxuICAgICAqIEByZXR1cm5zIGJvb2xlYW5cclxuICAgICAqL1xyXG4gICAgYWJzdHJhY3QgaXNBdXRoZW50aWNhdGVkKCk6IFByb21pc2U8Ym9vbGVhbj47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXRzIGluZGljYXRpb24gd2hldGhlciByZXF1ZXN0IHdhcyBkb25lIGZyb20gYXV0aGVudGljYXRpb24gcGFnZVxyXG4gICAgICogQHJldHVybnMgYm9vbGVhblxyXG4gICAgICovXHJcbiAgICBhYnN0cmFjdCBpc0F1dGhQYWdlKCk6IGJvb2xlYW47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZWRpcmVjdHMgY3VycmVudCBwYWdlIHRvIGF1dGhlbnRpY2F0aW9uIHBhZ2VcclxuICAgICAqL1xyXG4gICAgYWJzdHJhY3Qgc2hvd0F1dGhQYWdlKCk6IFByb21pc2U8Ym9vbGVhbj47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZWRpcmVjdHMgY3VycmVudCBwYWdlIHRvIGFjY2VzcyBkZW5pZWQgcGFnZVxyXG4gICAgICovXHJcbiAgICBhYnN0cmFjdCBzaG93QWNjZXNzRGVuaWVkKCk6IFByb21pc2U8Ym9vbGVhbj47XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBUb2tlbiB1c2VkIGZvciBpbmplY3RpbmcgY3VzdG9tIGNvbmZpZ3VyYXRpb24gZm9yIEF1dGhJbnRlcmNlcHRvclxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IEFVVEhfSU5URVJDRVBUT1JfQ09ORklHOiBJbmplY3Rpb25Ub2tlbjxBdXRoSW50ZXJjZXB0b3JDb25maWc+ID0gbmV3IEluamVjdGlvblRva2VuPEF1dGhJbnRlcmNlcHRvckNvbmZpZz4oXCJhdXRoLWludGVyY2VwdG9yLWNvbmZpZ1wiKTtcclxuXHJcbi8qKlxyXG4gKiBBdXRoSW50ZXJjZXB0b3IgdXNlZCBmb3IgaW50ZXJjZXB0aW5nIGh0dHAgcmVzcG9uc2VzIGFuZCBoYW5kbGluZyA0MDEsIDQwMyBzdGF0dXNlc1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEF1dGhJbnRlcmNlcHRvciBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvclxyXG57XHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHJpdmF0ZSBmaWVsZHMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ291bnRlciBmb3IgcmVxdWVzdHMgaW4gcHJvZ3Jlc3NcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfcmVxdWVzdHNJblByb2dyZXNzOiBudW1iZXIgPSAwO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5kaWNhdGlvbiB3aGV0aGVyIGlzIGhhbmRsaW5nIG9mIDQwMSwgNDAzIGJsb2NrZWQgYmVjYXVzZSBvbmUgcmVxdWVzdCBpcyBhbHJlYWR5IGhhbmRsZWRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfYmxvY2tlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwcml2YXRlIHByb3BlcnRpZXMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ291bnRlciBmb3IgcmVxdWVzdHMgaW4gcHJvZ3Jlc3NcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBzZXQgcmVxdWVzdHNJblByb2dyZXNzKHZhbHVlOiBudW1iZXIpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5fcmVxdWVzdHNJblByb2dyZXNzID0gdmFsdWU7XHJcblxyXG4gICAgICAgIGlmKHZhbHVlIDwgMSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX2Jsb2NrZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5fcmVxdWVzdHNJblByb2dyZXNzID0gMDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldCByZXF1ZXN0c0luUHJvZ3Jlc3MoKTogbnVtYmVyXHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3JlcXVlc3RzSW5Qcm9ncmVzcztcclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgY29uc3RydWN0b3JzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NvbmZpZzogQXV0aEludGVyY2VwdG9yQ29uZmlnLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBfaWdub3JlZEludGVyY2VwdG9yc1NlcnZpY2U6IElnbm9yZWRJbnRlcmNlcHRvcnNTZXJ2aWNlKVxyXG4gICAge1xyXG4gICAgfVxyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwdWJsaWMgbWV0aG9kcyAtIGltcGxlbWVudGF0aW9uIG9mIEh0dHBJbnRlcmNlcHRvciAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbnRlcmNlcHRzIGh0dHAgcmVxdWVzdFxyXG4gICAgICogQHBhcmFtIHJlcSBSZXF1ZXN0IHRvIGJlIGludGVyY2VwdGVkXHJcbiAgICAgKiBAcGFyYW0gbmV4dCBOZXh0IG1pZGRsZXdhcmUgdGhhdCBjYW4gYmUgY2FsbGVkIGZvciBuZXh0IHByb2Nlc3NpbmdcclxuICAgICAqL1xyXG4gICAgcHVibGljIGludGVyY2VwdChyZXE6IEh0dHBSZXF1ZXN0SWdub3JlZEludGVyY2VwdG9ySWQ8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PlxyXG4gICAge1xyXG4gICAgICAgIHRoaXMucmVxdWVzdHNJblByb2dyZXNzKys7XHJcblxyXG4gICAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpLnBpcGUoY2F0Y2hFcnJvcigoZXJyKSA9PlxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogT2JzZXJ2ZXI8YW55PikgPT5cclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgLy9jbGllbnQgZXJyb3IsIG5vdCByZXNwb25zZSBmcm9tIHNlcnZlciwgb3IgaXMgaWdub3JlZFxyXG4gICAgICAgICAgICAgICAgaWYgKGVyci5lcnJvciBpbnN0YW5jZW9mIEVycm9yIHx8IFxyXG4gICAgICAgICAgICAgICAgICAgICh0aGlzLl9pZ25vcmVkSW50ZXJjZXB0b3JzU2VydmljZSAmJiB0aGlzLl9pZ25vcmVkSW50ZXJjZXB0b3JzU2VydmljZS5pc0lnbm9yZWQoQXV0aEludGVyY2VwdG9yLCByZXEpKSlcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvL2lmIGF1dGggZXJyb3JcclxuICAgICAgICAgICAgICAgIGlmKGVyci5zdGF0dXMgPT0gNDAzIHx8IGVyci5zdGF0dXMgPT0gNDAxKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuX2Jsb2NrZWQpXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmxvY2tlZCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vYXV0aCBlcnJvciBmcm9tIGF1dGggcGFnZVxyXG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuX2NvbmZpZy5pc0F1dGhQYWdlKCkpXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy9hdXRoIGVycm9yIGZyb20gb3RoZXIgcGFnZXNcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25maWcuaXNBdXRoZW50aWNhdGVkKClcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oYXN5bmMgaXNBdXRoZW50aWNhdGVkID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vYWNjZXNzIGRlbmllZCB1c2VyIGF1dGhlbnRpY2F0ZWQsIG5vdCBhdXRob3JpemVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc0F1dGhlbnRpY2F0ZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fY29uZmlnLnNob3dBY2Nlc3NEZW5pZWQoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vc2hvdyBhdXRoIHBhZ2UsIHVzZXIgbm90IGF1dGhlbnRpY2F0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2NvbmZpZy5zaG93QXV0aFBhZ2UoKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IG9ic2VydmVyLmNvbXBsZXRlKCkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgLy9vdGhlciBlcnJvcnNcclxuICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XHJcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9KSBhcyBPYnNlcnZhYmxlSW5wdXQ8SHR0cEV2ZW50PGFueT4+O1xyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLnJlcXVlc3RzSW5Qcm9ncmVzcy0tLCAoKSA9PiB0aGlzLnJlcXVlc3RzSW5Qcm9ncmVzcy0tKSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBGYWN0b3J5IHVzZWQgZm9yIGNyZWF0aW5nIGF1dGggaW50ZXJjZXB0b3JcclxuICogQHBhcmFtIGNvbmZpZyBDb25maWd1cmF0aW9uIGZvciBhdXRoIGludGVyY2VwdG9yXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gYXV0aEludGVyY2VwdG9yUHJvdmlkZXJGYWN0b3J5KGNvbmZpZzogQXV0aEludGVyY2VwdG9yQ29uZmlnLCBpbmplY3RvcjogSW5qZWN0b3IpXHJcbntcclxuICAgIGlmKGlzQmxhbmsoY29uZmlnKSB8fCAhKGNvbmZpZyBpbnN0YW5jZW9mIEF1dGhJbnRlcmNlcHRvckNvbmZpZykpXHJcbiAgICB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUHJvdmlkZWQgY29uZmlndXJhdGlvbiBmb3IgJ0F1dGhJbnRlcmNlcHRvcicgaXMgbm90IG9mIHR5cGUgJ0F1dEludGVyY2VwdG9yQ29uZmlnJywgeW91IG11c3QgcHJvdmlkZSBvbmUhXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXcgQXV0aEludGVyY2VwdG9yKGNvbmZpZywgaW5qZWN0b3IuZ2V0KElnbm9yZWRJbnRlcmNlcHRvcnNTZXJ2aWNlKSk7XHJcbn07XHJcblxyXG4vKipcclxuICogUHJvdmlkZXIgZm9yIHByb3BlciB1c2Ugb2YgQXV0aEludGVyY2VwdG9yLCB1c2UgdGhpcyBwcm92aWRlciB0byBpbmplY3QgdGhpcyBpbnRlcmNlcHRvclxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IEFVVEhfSU5URVJDRVBUT1JfUFJPVklERVI6IEZhY3RvcnlQcm92aWRlciA9XHJcbntcclxuICAgIHByb3ZpZGU6IEhUVFBfSU5URVJDRVBUT1JTLFxyXG4gICAgbXVsdGk6IHRydWUsXHJcbiAgICB1c2VGYWN0b3J5OiBhdXRoSW50ZXJjZXB0b3JQcm92aWRlckZhY3RvcnksXHJcbiAgICBkZXBzOiBbQVVUSF9JTlRFUkNFUFRPUl9DT05GSUcsIEluamVjdG9yXVxyXG59OyJdfQ==