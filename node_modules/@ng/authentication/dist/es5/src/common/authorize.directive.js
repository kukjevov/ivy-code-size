/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, TemplateRef, ViewContainerRef, Input, ChangeDetectorRef } from '@angular/core';
import { isString, isBoolean, isBlank } from '@asseco/common';
import { AuthenticationService } from './authentication.service';
var AuthorizeDirective = /** @class */ (function () {
    //######################### constructor #########################
    function AuthorizeDirective(_template, _viewContainer, _authService, _changeDetector) {
        this._template = _template;
        this._viewContainer = _viewContainer;
        this._authService = _authService;
        this._changeDetector = _changeDetector;
        //######################### private fields #########################
        /**
         * Subscription for changes in authentication
         */
        this._subscription = null;
        /**
         * Indication that AND condition should be used instead of OR condition if multiple permissions are provided
         */
        this.andCondition = false;
        /**
         * Indication that provided string is set of loggical operations among permission names, if this is true andCondition is ignored
         */
        this.conditionString = false;
    }
    //######################### public methods - implementation of OnInit #########################
    /**
     * Initialize component
     */
    //######################### public methods - implementation of OnInit #########################
    /**
     * Initialize component
     * @return {?}
     */
    AuthorizeDirective.prototype.ngOnInit = 
    //######################### public methods - implementation of OnInit #########################
    /**
     * Initialize component
     * @return {?}
     */
    function () {
        var _this = this;
        if (isBlank(this.permission)) {
            throw new Error("You must specify 'authorize' attribute value.");
        }
        if (!isBoolean(this.andCondition)) {
            throw new Error("Parameter 'andCondition' must be boolean value!");
        }
        if (!isBoolean(this.conditionString)) {
            throw new Error("Parameter 'conditionString' must be boolean value!");
        }
        if (isString(this.permission) && this.permission.indexOf(",") > -1) {
            this.permission = this.permission.split(",").map((/**
             * @param {?} itm
             * @return {?}
             */
            function (itm) { return itm.trim(); }));
        }
        this._authService
            .getUserIdentity()
            .then((/**
         * @param {?} userIdentity
         * @return {?}
         */
        function (userIdentity) {
            _this._renderIfPermission(userIdentity);
            _this._changeDetector.detectChanges();
        }));
        this._subscription = this._authService
            .authenticationChanged
            .subscribe((/**
         * @param {?} userIdentity
         * @return {?}
         */
        function (userIdentity) {
            _this._renderIfPermission(userIdentity);
            _this._changeDetector.detectChanges();
        }), (/**
         * @return {?}
         */
        function () { }));
    };
    //######################### public methods - implementation of OnDestroy #########################
    /**
     * Called when component is destroyed
     */
    //######################### public methods - implementation of OnDestroy #########################
    /**
     * Called when component is destroyed
     * @return {?}
     */
    AuthorizeDirective.prototype.ngOnDestroy = 
    //######################### public methods - implementation of OnDestroy #########################
    /**
     * Called when component is destroyed
     * @return {?}
     */
    function () {
        if (this._subscription) {
            this._subscription.unsubscribe();
            this._subscription = null;
        }
    };
    //######################### private methods #########################
    /**
     * Renders content if user has permissions
     */
    //######################### private methods #########################
    /**
     * Renders content if user has permissions
     * @private
     * @param {?} userIdentity
     * @return {?}
     */
    AuthorizeDirective.prototype._renderIfPermission = 
    //######################### private methods #########################
    /**
     * Renders content if user has permissions
     * @private
     * @param {?} userIdentity
     * @return {?}
     */
    function (userIdentity) {
        if (!isString(this.permission) && !Array.isArray(this.permission)) {
            throw new Error("Invalid argument type! Permission must be string or array of strings.");
        }
        if (userIdentity) {
            this._viewContainer.clear();
            //Multiple conditions
            if (Array.isArray(this.permission)) {
                /** @type {?} */
                var arrayPermission = (/** @type {?} */ (this.permission));
                if (this.andCondition) {
                    //AND Condition
                    if (arrayPermission.map((/**
                     * @param {?} perm
                     * @return {?}
                     */
                    function (perm) { return userIdentity.permissions.indexOf(perm) > -1; })).every((/**
                     * @param {?} itm
                     * @return {?}
                     */
                    function (itm) { return itm === true; }))) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
                else {
                    //OR Condition
                    if (arrayPermission.map((/**
                     * @param {?} perm
                     * @return {?}
                     */
                    function (perm) { return userIdentity.permissions.indexOf(perm) > -1; })).indexOf(true) > -1) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
            }
            //Single condition
            else {
                //Condition string
                if (this.conditionString) {
                    //TODO - think of some optimization for performance reasons
                    /** @type {?} */
                    var condition_1 = (/** @type {?} */ (this.permission));
                    condition_1.replace(/!?(.*?)(?:&+|\|+|\(|\)|$)/g, "$1")
                        .split(" ")
                        .filter((/**
                     * @param {?} itm
                     * @return {?}
                     */
                    function (itm) { return itm.trim(); }))
                        .forEach((/**
                     * @param {?} permissionName
                     * @return {?}
                     */
                    function (permissionName) { return condition_1 = condition_1.replace(new RegExp(permissionName, 'g'), (userIdentity.permissions.indexOf(permissionName) > -1).toString()); }));
                    if (new Function("return (" + condition_1 + ")")()) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
                //Permission name string
                else {
                    /** @type {?} */
                    var stringPermission = (/** @type {?} */ (this.permission));
                    if (userIdentity.permissions.indexOf(stringPermission) > -1) {
                        this._viewContainer.createEmbeddedView(this._template);
                    }
                }
            }
        }
    };
    AuthorizeDirective.decorators = [
        { type: Directive, args: [{
                    selector: "[authorize]"
                },] }
    ];
    /** @nocollapse */
    AuthorizeDirective.ctorParameters = function () { return [
        { type: TemplateRef },
        { type: ViewContainerRef },
        { type: AuthenticationService },
        { type: ChangeDetectorRef }
    ]; };
    AuthorizeDirective.propDecorators = {
        permission: [{ type: Input, args: ["authorize",] }],
        andCondition: [{ type: Input, args: ["authorizeAndCondition",] }],
        conditionString: [{ type: Input, args: ["authorizeConditionString",] }]
    };
    return AuthorizeDirective;
}());
export { AuthorizeDirective };
if (false) {
    /**
     * Subscription for changes in authentication
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._subscription;
    /**
     * Name of permission that is requested for displaying element
     * @type {?}
     */
    AuthorizeDirective.prototype.permission;
    /**
     * Indication that AND condition should be used instead of OR condition if multiple permissions are provided
     * @type {?}
     */
    AuthorizeDirective.prototype.andCondition;
    /**
     * Indication that provided string is set of loggical operations among permission names, if this is true andCondition is ignored
     * @type {?}
     */
    AuthorizeDirective.prototype.conditionString;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._template;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._viewContainer;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._authService;
    /**
     * @type {?}
     * @private
     */
    AuthorizeDirective.prototype._changeDetector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aG9yaXplLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tb24vYXV0aG9yaXplLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQVUsS0FBSyxFQUFhLGlCQUFpQixFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3BILE9BQU8sRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRzVELE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBRy9EO0lBaUNJLGlFQUFpRTtJQUNqRSw0QkFBb0IsU0FBMkIsRUFDM0IsY0FBZ0MsRUFDaEMsWUFBd0MsRUFDeEMsZUFBa0M7UUFIbEMsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFDM0IsbUJBQWMsR0FBZCxjQUFjLENBQWtCO1FBQ2hDLGlCQUFZLEdBQVosWUFBWSxDQUE0QjtRQUN4QyxvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7Ozs7O1FBMUI5QyxrQkFBYSxHQUFzQixJQUFJLENBQUM7Ozs7UUFjekMsaUJBQVksR0FBWSxLQUFLLENBQUM7Ozs7UUFNOUIsb0JBQWUsR0FBWSxLQUFLLENBQUM7SUFReEMsQ0FBQztJQUVELCtGQUErRjtJQUUvRjs7T0FFRzs7Ozs7O0lBQ0kscUNBQVE7Ozs7OztJQUFmO1FBQUEsaUJBcUNDO1FBbkNHLElBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFDM0I7WUFDSSxNQUFNLElBQUksS0FBSyxDQUFDLCtDQUErQyxDQUFDLENBQUM7U0FDcEU7UUFFRCxJQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFDaEM7WUFDSSxNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7U0FDdEU7UUFFRCxJQUFHLENBQUMs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cUJBQzFEO2lCQUNKO2FBQ0o7U0FDSjtJQUNMLENBQUM7O2dCQXZLSixTQUFTLFNBQ1Y7b0JBQ0ksUUFBUSxFQUFFLGFBQWE7aUJBQzFCOzs7O2dCQVZrQixXQUFXO2dCQUFFLGdCQUFnQjtnQkFJeEMscUJBQXFCO2dCQUorQyxpQkFBaUI7Ozs2QkF5QnhGLEtBQUssU0FBQyxXQUFXOytCQU1qQixLQUFLLFNBQUMsdUJBQXVCO2tDQU03QixLQUFLLFNBQUMsMEJBQTBCOztJQTBJckMseUJBQUM7Q0FBQSxBQXhLRCxJQXdLQztTQXBLWSxrQkFBa0I7Ozs7Ozs7SUFPM0IsMkNBQWdEOzs7OztJQU9oRCx3Q0FDcUM7Ozs7O0lBS3JDLDBDQUNxQzs7Ozs7SUFLckMsNkNBQ3dDOzs7OztJQUc1Qix1Q0FBbUM7Ozs7O0lBQ25DLDRDQUF3Qzs7Ozs7SUFDeEMsMENBQWdEOzs7OztJQUNoRCw2Q0FBMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RpcmVjdGl2ZSwgVGVtcGxhdGVSZWYsIFZpZXdDb250YWluZXJSZWYsIE9uSW5pdCwgSW5wdXQsIE9uRGVzdHJveSwgQ2hhbmdlRGV0ZWN0b3JSZWZ9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge2lzU3RyaW5nLCBpc0Jvb2xlYW4sIGlzQmxhbmt9IGZyb20gJ0Bhc3NlY28vY29tbW9uJztcclxuaW1wb3J0IHtTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHtBdXRoZW50aWNhdGlvblNlcnZpY2V9IGZyb20gJy4vYXV0aGVudGljYXRpb24uc2VydmljZSc7XHJcbmltcG9ydCB7VXNlcklkZW50aXR5fSBmcm9tICcuL3VzZXJJZGVudGl0eSc7XHJcblxyXG5ARGlyZWN0aXZlKFxyXG57XHJcbiAgICBzZWxlY3RvcjogXCJbYXV0aG9yaXplXVwiXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBBdXRob3JpemVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveVxyXG57XHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHJpdmF0ZSBmaWVsZHMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogU3Vic2NyaXB0aW9uIGZvciBjaGFuZ2VzIGluIGF1dGhlbnRpY2F0aW9uXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX3N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9ufG51bGwgPSBudWxsO1xyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwdWJsaWMgcHJvcGVydGllcyAtIGlucHV0cyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBOYW1lIG9mIHBlcm1pc3Npb24gdGhhdCBpcyByZXF1ZXN0ZWQgZm9yIGRpc3BsYXlpbmcgZWxlbWVudFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoXCJhdXRob3JpemVcIilcclxuICAgIHB1YmxpYyBwZXJtaXNzaW9uOiBzdHJpbmcgfCBzdHJpbmdbXTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEluZGljYXRpb24gdGhhdCBBTkQgY29uZGl0aW9uIHNob3VsZCBiZSB1c2VkIGluc3RlYWQgb2YgT1IgY29uZGl0aW9uIGlmIG11bHRpcGxlIHBlcm1pc3Npb25zIGFyZSBwcm92aWRlZFxyXG4gICAgICovXHJcbiAgICBASW5wdXQoXCJhdXRob3JpemVBbmRDb25kaXRpb25cIilcclxuICAgIHB1YmxpYyBhbmRDb25kaXRpb246IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEluZGljYXRpb24gdGhhdCBwcm92aWRlZCBzdHJpbmcgaXMgc2V0IG9mIGxvZ2dpY2FsIG9wZXJhdGlvbnMgYW1vbmcgcGVybWlzc2lvbiBuYW1lcywgaWYgdGhpcyBpcyB0cnVlIGFuZENvbmRpdGlvbiBpcyBpZ25vcmVkXHJcbiAgICAgKi9cclxuICAgIEBJbnB1dChcImF1dGhvcml6ZUNvbmRpdGlvblN0cmluZ1wiKVxyXG4gICAgcHVibGljIGNvbmRpdGlvblN0cmluZzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgY29uc3RydWN0b3IgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfdGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4sXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIF92aWV3Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBfYXV0aFNlcnZpY2U6IEF1dGhlbnRpY2F0aW9uU2VydmljZTxhbnk+LFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBfY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmKVxyXG4gICAge1xyXG4gICAgfVxyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwdWJsaWMgbWV0aG9kcyAtIGltcGxlbWVudGF0aW9uIG9mIE9uSW5pdCAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbml0aWFsaXplIGNvbXBvbmVudFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgbmdPbkluaXQoKVxyXG4gICAge1xyXG4gICAgICAgIGlmKGlzQmxhbmsodGhpcy5wZXJtaXNzaW9uKSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBtdXN0IHNwZWNpZnkgJ2F1dGhvcml6ZScgYXR0cmlidXRlIHZhbHVlLlwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKCFpc0Jvb2xlYW4odGhpcy5hbmRDb25kaXRpb24pKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGFyYW1ldGVyICdhbmRDb25kaXRpb24nIG11c3QgYmUgYm9vbGVhbiB2YWx1ZSFcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZighaXNCb29sZWFuKHRoaXMuY29uZGl0aW9uU3RyaW5nKSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBhcmFtZXRlciAnY29uZGl0aW9uU3RyaW5nJyBtdXN0IGJlIGJvb2xlYW4gdmFsdWUhXCIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYoaXNTdHJpbmcodGhpcy5wZXJtaXNzaW9uKSAmJiB0aGlzLnBlcm1pc3Npb24uaW5kZXhPZihcIixcIikgPiAtMSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMucGVybWlzc2lvbiA9IHRoaXMucGVybWlzc2lvbi5zcGxpdChcIixcIikubWFwKGl0bSA9PiBpdG0udHJpbSgpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2F1dGhTZXJ2aWNlXHJcbiAgICAgICAgICAgIC5nZXRVc2VySWRlbnRpdHkoKVxyXG4gICAgICAgICAgICAudGhlbih1c2VySWRlbnRpdHkgPT5cclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVuZGVySWZQZXJtaXNzaW9uKHVzZXJJZGVudGl0eSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb24gPSB0aGlzLl9hdXRoU2VydmljZVxyXG4gICAgICAgICAgICAuYXV0aGVudGljYXRpb25DaGFuZ2VkXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUodXNlcklkZW50aXR5ID0+XHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlcklmUGVybWlzc2lvbih1c2VySWRlbnRpdHkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICB9LCAoKSA9PiB7fSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwdWJsaWMgbWV0aG9kcyAtIGltcGxlbWVudGF0aW9uIG9mIE9uRGVzdHJveSAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcbiAgICBcclxuICAgIC8qKlxyXG4gICAgICogQ2FsbGVkIHdoZW4gY29tcG9uZW50IGlzIGRlc3Ryb3llZFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgbmdPbkRlc3Ryb3koKVxyXG4gICAge1xyXG4gICAgICAgIGlmKHRoaXMuX3N1YnNjcmlwdGlvbilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHJpdmF0ZSBtZXRob2RzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIFJlbmRlcnMgY29udGVudCBpZiB1c2VyIGhhcyBwZXJtaXNzaW9uc1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9yZW5kZXJJZlBlcm1pc3Npb24odXNlcklkZW50aXR5OiBVc2VySWRlbnRpdHk8YW55PilcclxuICAgIHtcclxuICAgICAgICBpZighaXNTdHJpbmcodGhpcy5wZXJtaXNzaW9uKSAmJiAhQXJyYXkuaXNBcnJheSh0aGlzLnBlcm1pc3Npb24pKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBhcmd1bWVudCB0eXBlISBQZXJtaXNzaW9uIG11c3QgYmUgc3RyaW5nIG9yIGFycmF5IG9mIHN0cmluZ3MuXCIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYodXNlcklkZW50aXR5KVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fdmlld0NvbnRhaW5lci5jbGVhcigpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAvL011bHRpcGxlIGNvbmRpdGlvbnNcclxuICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheSh0aGlzLnBlcm1pc3Npb24pKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBsZXQgYXJyYXlQZXJtaXNzaW9uOiBzdHJpbmdbXSA9IDxzdHJpbmdbXT50aGlzLnBlcm1pc3Npb247XHJcblxyXG4gICAgICAgICAgICAgICAgaWYodGhpcy5hbmRDb25kaXRpb24pXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9BTkQgQ29uZGl0aW9uXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoYXJyYXlQZXJtaXNzaW9uLm1hcChwZXJtID0+IHVzZXJJZGVudGl0eS5wZXJtaXNzaW9ucy5pbmRleE9mKHBlcm0pID4gLTEpLmV2ZXJ5KGl0bSA9PiBpdG0gPT09IHRydWUpKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmlld0NvbnRhaW5lci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy5fdGVtcGxhdGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAvL09SIENvbmRpdGlvblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKGFycmF5UGVybWlzc2lvbi5tYXAocGVybSA9PiB1c2VySWRlbnRpdHkucGVybWlzc2lvbnMuaW5kZXhPZihwZXJtKSA+IC0xKS5pbmRleE9mKHRydWUpID4gLTEpXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92aWV3Q29udGFpbmVyLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLl90ZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vU2luZ2xlIGNvbmRpdGlvblxyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIC8vQ29uZGl0aW9uIHN0cmluZ1xyXG4gICAgICAgICAgICAgICAgaWYodGhpcy5jb25kaXRpb25TdHJpbmcpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9UT0RPIC0gdGhpbmsgb2Ygc29tZSBvcHRpbWl6YXRpb24gZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnNcclxuICAgICAgICAgICAgICAgICAgICBsZXQgY29uZGl0aW9uOiBzdHJpbmcgPSA8c3RyaW5nPnRoaXMucGVybWlzc2lvbjtcclxuICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24ucmVwbGFjZSgvIT8oLio/KSg/OiYrfFxcfCt8XFwofFxcKXwkKS9nLCBcIiQxXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zcGxpdChcIiBcIilcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbihpdG0pe3JldHVybiBpdG0udHJpbSgpfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmZvckVhY2gocGVybWlzc2lvbk5hbWUgPT4gY29uZGl0aW9uID0gY29uZGl0aW9uLnJlcGxhY2UobmV3IFJlZ0V4cChwZXJtaXNzaW9uTmFtZSwgJ2cnKSwgKHVzZXJJZGVudGl0eS5wZXJtaXNzaW9ucy5pbmRleE9mKHBlcm1pc3Npb25OYW1lKSA+IC0xKS50b1N0cmluZygpKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKG5ldyBGdW5jdGlvbihgcmV0dXJuICgke2NvbmRpdGlvbn0pYCkoKSlcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuX3RlbXBsYXRlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvL1Blcm1pc3Npb24gbmFtZSBzdHJpbmdcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3RyaW5nUGVybWlzc2lvbjogc3RyaW5nID0gPHN0cmluZz50aGlzLnBlcm1pc3Npb247XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmKHVzZXJJZGVudGl0eS5wZXJtaXNzaW9ucy5pbmRleE9mKHN0cmluZ1Blcm1pc3Npb24pID4gLTEpXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92aWV3Q29udGFpbmVyLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLl90ZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19