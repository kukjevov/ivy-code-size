/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject, Injector } from '@angular/core';
import { isFunction, isArray, isBlank } from '@asseco/common';
import { Observable, Subject, empty } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { AUTHENTICATION_SERVICE_OPTIONS } from './authenticationServiceOptions.interface';
import * as i0 from "@angular/core";
import * as i1 from "./authenticationServiceOptions.interface";
/**
 * Factory used for creating AuthenticationService
 * @param {?} options Options passed to created service
 * @return {?}
 */
export function authenticationServiceFactory(options) {
    if (isBlank(options) ||
        isBlank(options.getUserIdentity) || !isFunction(options.getUserIdentity) ||
        isBlank(options.login) || !isFunction(options.login) ||
        isBlank(options.logout) || !isFunction(options.logout) ||
        isBlank(options.isAuthPage) || !isFunction(options.isAuthPage) ||
        isBlank(options.showAccessDenied) || !isFunction(options.showAccessDenied) ||
        isBlank(options.showAuthPage) || !isFunction(options.showAuthPage)) {
        throw new Error("Options must be set and must implement AuthenticationServiceOptions");
    }
    return new AuthenticationService(options);
}
/**
 * Authentication service managing authentication
 * @template TUserInfo
 */
var AuthenticationService = /** @class */ (function () {
    //######################### constructor #########################
    //TODO - report bug, this is HACK to be compilable
    function AuthenticationService(_options) {
        var _this = this;
        this._options = _options;
        /**
         * Subject used for indicating authenticationChanged
         */
        this._authenticationChangedSubject = new Subject();
        this.isInitialized = new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        function (resolve) { return _this._isInitializedResolver = resolve; }));
    }
    Object.defineProperty(AuthenticationService.prototype, "authenticationChanged", {
        /**
         * Gets observable that indicates when authentication has changed
         */
        get: /**
         * Gets observable that indicates when authentication has changed
         * @return {?}
         */
        function () {
            return this._authenticationChangedSubject.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    //######################### public methods #########################
    /**
     * Tests whether is used authorized for specified permission
     * @param permission Permission name that is tested
     * @returns Promise<boolean> True if user is authorized otherwise false
     */
    //######################### public methods #########################
    /**
     * Tests whether is used authorized for specified permission
     * @param {?} permission Permission name that is tested
     * @return {?} Promise<boolean> True if user is authorized otherwise false
     */
    AuthenticationService.prototype.isAuthorized = 
    //######################### public methods #########################
    /**
     * Tests whether is used authorized for specified permission
     * @param {?} permission Permission name that is tested
     * @return {?} Promise<boolean> True if user is authorized otherwise false
     */
    function (permission) {
        var _this = this;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            _this.getUserIdentity()
                .then((/**
             * @param {?} userIdentity
             * @return {?}
             */
            function (userIdentity) {
                if (isArray(userIdentity.permissions)) {
                    if (userIdentity.permissions.indexOf(permission) > -1) {
                        resolve(true);
                    }
                    else {
                        resolve(false);
                    }
                }
                else {
                    resolve(false);
                }
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            function (error) { return reject(error); }));
        }));
    };
    /**
     * Gets user identity
     * @param refresh? Indication that server get user identity should be called, otherwise cached response will be used
     * @returns Promise
     */
    /**
     * Gets user identity
     * @param {?=} refresh
     * @return {?} Promise
     */
    AuthenticationService.prototype.getUserIdentity = /**
     * Gets user identity
     * @param {?=} refresh
     * @return {?} Promise
     */
    function (refresh) {
        var _this = this;
        if (refresh === true) {
            this._authenticationPromise = null;
        }
        if (this._authenticationPromise != null) {
            return this._authenticationPromise;
        }
        this._authenticationPromise = new Promise((/**
         * @param {?} success
         * @param {?} reject
         * @return {?}
         */
        function (success, reject) {
            _this._options
                .getUserIdentity()
                .pipe(catchError((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                reject(error);
                _this._isInitializedResolver(true);
                return empty();
            })))
                .subscribe((/**
             * @param {?} itm
             * @return {?}
             */
            function (itm) {
                success(itm);
                _this._authenticationChangedSubject.next(itm);
                _this._isInitializedResolver(true);
            }));
        }));
        return this._authenticationPromise;
    };
    /**
     * Method logs user into system
     * @param accessToken Access token holding authentication information
     * @returns Observable
     */
    /**
     * Method logs user into system
     * @param {?} accessToken Access token holding authentication information
     * @return {?} Observable
     */
    AuthenticationService.prototype.login = /**
     * Method logs user into system
     * @param {?} accessToken Access token holding authentication information
     * @return {?} Observable
     */
    function (accessToken) {
        var _this = this;
        return Observable.create((/**
         * @param {?} observer
         * @return {?}
         */
        function (observer) {
            _this._options.login(accessToken)
                .subscribe((/**
             * @return {?}
             */
            function () {
                _this.getUserIdentity(true)
                    .then((/**
                 * @return {?}
                 */
                function () {
                    observer.next(null);
                }));
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                observer.error(error);
            }));
        }));
    };
    /**
     * Methods logs out user out of system
     * @returns Observable
     */
    /**
     * Methods logs out user out of system
     * @return {?} Observable
     */
    AuthenticationService.prototype.logout = /**
     * Methods logs out user out of system
     * @return {?} Observable
     */
    function () {
        var _this = this;
        return Observable.create((/**
         * @param {?} observer
         * @return {?}
         */
        function (observer) {
            _this._options.logout()
                .subscribe((/**
             * @return {?}
             */
            function () {
                _this.getUserIdentity(true)
                    .then((/**
                 * @return {?}
                 */
                function () {
                    observer.next(null);
                }));
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                observer.error(error);
            }));
        }));
    };
    /**
     * Redirects current page to authentication page
     */
    /**
     * Redirects current page to authentication page
     * @return {?}
     */
    AuthenticationService.prototype.showAuthPage = /**
     * Redirects current page to authentication page
     * @return {?}
     */
    function () {
        return this._options.showAuthPage();
    };
    /**
     * Redirects current page to access denied page
     */
    /**
     * Redirects current page to access denied page
     * @return {?}
     */
    AuthenticationService.prototype.showAccessDenied = /**
     * Redirects current page to access denied page
     * @return {?}
     */
    function () {
        return this._options.showAccessDenied();
    };
    /**
     * Gets indicatio whether current state of app is displaying login page
     * @returns boolean
     */
    /**
     * Gets indicatio whether current state of app is displaying login page
     * @return {?} boolean
     */
    AuthenticationService.prototype.isAuthPage = /**
     * Gets indicatio whether current state of app is displaying login page
     * @return {?} boolean
     */
    function () {
        return this._options.isAuthPage();
    };
    AuthenticationService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root', deps: [AUTHENTICATION_SERVICE_OPTIONS], useFactory: authenticationServiceFactory },] }
    ];
    /** @nocollapse */
    AuthenticationService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [Injector,] }] }
    ]; };
    /** @nocollapse */ AuthenticationService.ngInjectableDef = i0.defineInjectable({ factory: function AuthenticationService_Factory() { return authenticationServiceFactory(i0.inject(i1.AUTHENTICATION_SERVICE_OPTIONS)); }, token: AuthenticationService, providedIn: "root" });
    return AuthenticationService;
}());
export { AuthenticationService };
if (false) {
    /**
     * Authentication promise that was used for authentication
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._authenticationPromise;
    /**
     * Resolved function for isInitialized
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._isInitializedResolver;
    /**
     * Subject used for indicating authenticationChanged
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._authenticationChangedSubject;
    /**
     * Indication whether is authentication module initialized or not
     * @type {?}
     */
    AuthenticationService.prototype.isInitialized;
    /**
     * @type {?}
     * @private
     */
    AuthenticationService.prototype._options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tb24vYXV0aGVudGljYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzNELE9BQU8sRUFBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzVELE9BQU8sRUFBQyxVQUFVLEVBQVksT0FBTyxFQUFFLEtBQUssRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFHMUMsT0FBTyxFQUErQiw4QkFBOEIsRUFBQyxNQUFNLDBDQUEwQyxDQUFDOzs7Ozs7OztBQU90SCxNQUFNLFVBQVUsNEJBQTRCLENBQUMsT0FBMEM7SUFFbkYsSUFBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBQ2hCLE9BQU8sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQztRQUN4RSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDcEQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3RELE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztRQUM5RCxPQUFPLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDO1FBQzFFLE9BQU8sQ0FBQyxP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QUN4QyxDQUFDO0lBRUQ7O09BRUc7Ozs7O0lBQ0ksZ0RBQWdCOzs7O0lBQXZCO1FBRUksT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDNUMsQ0FBQztJQUVEOzs7T0FHRzs7Ozs7SUFDSSwwQ0FBVTs7OztJQUFqQjtRQUVJLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUN0QyxDQUFDOztnQkF6TEosVUFBVSxTQUFDLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyw4QkFBOEIsQ0FBQyxFQUFFLFVBQVUsRUFBRSw0QkFBNEIsRUFBQzs7OztnREFxQ2pHLE1BQU0sU0FBQyxRQUFROzs7Z0NBckVoQztDQTBOQyxBQTFMRCxJQTBMQztTQXpMWSxxQkFBcUI7Ozs7Ozs7SUFPOUIsdURBQXNFOzs7Ozs7SUFLdEUsdURBQThEOzs7Ozs7SUFLOUQsOERBQWlIOzs7OztJQU9qSCw4Q0FBdUM7Ozs7O0lBWTNCLHlDQUEyRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZSwgSW5qZWN0LCBJbmplY3Rvcn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7aXNGdW5jdGlvbiwgaXNBcnJheSwgaXNCbGFua30gZnJvbSAnQGFzc2Vjby9jb21tb24nO1xyXG5pbXBvcnQge09ic2VydmFibGUsIE9ic2VydmVyLCBTdWJqZWN0LCBlbXB0eX0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7Y2F0Y2hFcnJvcn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHtVc2VySWRlbnRpdHl9IGZyb20gJy4vdXNlcklkZW50aXR5JztcclxuaW1wb3J0IHtBdXRoZW50aWNhdGlvblNlcnZpY2VPcHRpb25zLCBBVVRIRU5USUNBVElPTl9TRVJWSUNFX09QVElPTlN9IGZyb20gJy4vYXV0aGVudGljYXRpb25TZXJ2aWNlT3B0aW9ucy5pbnRlcmZhY2UnO1xyXG5pbXBvcnQge0FjY2Vzc1Rva2VufSBmcm9tICcuL2FjY2Vzc1Rva2VuJztcclxuXHJcbi8qKlxyXG4gKiBGYWN0b3J5IHVzZWQgZm9yIGNyZWF0aW5nIEF1dGhlbnRpY2F0aW9uU2VydmljZVxyXG4gKiBAcGFyYW0gb3B0aW9ucyBPcHRpb25zIHBhc3NlZCB0byBjcmVhdGVkIHNlcnZpY2VcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBhdXRoZW50aWNhdGlvblNlcnZpY2VGYWN0b3J5KG9wdGlvbnM6IEF1dGhlbnRpY2F0aW9uU2VydmljZU9wdGlvbnM8YW55Pilcclxue1xyXG4gICAgaWYoaXNCbGFuayhvcHRpb25zKSB8fFxyXG4gICAgICAgaXNCbGFuayhvcHRpb25zLmdldFVzZXJJZGVudGl0eSkgfHwgIWlzRnVuY3Rpb24ob3B0aW9ucy5nZXRVc2VySWRlbnRpdHkpIHx8XHJcbiAgICAgICBpc0JsYW5rKG9wdGlvbnMubG9naW4pIHx8ICFpc0Z1bmN0aW9uKG9wdGlvbnMubG9naW4pIHx8XHJcbiAgICAgICBpc0JsYW5rKG9wdGlvbnMubG9nb3V0KSB8fCAhaXNGdW5jdGlvbihvcHRpb25zLmxvZ291dCkgfHxcclxuICAgICAgIGlzQmxhbmsob3B0aW9ucy5pc0F1dGhQYWdlKSB8fCAhaXNGdW5jdGlvbihvcHRpb25zLmlzQXV0aFBhZ2UpIHx8XHJcbiAgICAgICBpc0JsYW5rKG9wdGlvbnMuc2hvd0FjY2Vzc0RlbmllZCkgfHwgIWlzRnVuY3Rpb24ob3B0aW9ucy5zaG93QWNjZXNzRGVuaWVkKSB8fFxyXG4gICAgICAgaXNCbGFuayhvcHRpb25zLnNob3dBdXRoUGFnZSkgfHwgIWlzRnVuY3Rpb24ob3B0aW9ucy5zaG93QXV0aFBhZ2UpKVxyXG4gICAge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk9wdGlvbnMgbXVzdCBiZSBzZXQgYW5kIG11c3QgaW1wbGVtZW50IEF1dGhlbnRpY2F0aW9uU2VydmljZU9wdGlvbnNcIik7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ldyBBdXRoZW50aWNhdGlvblNlcnZpY2Uob3B0aW9ucyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBdXRoZW50aWNhdGlvbiBzZXJ2aWNlIG1hbmFnaW5nIGF1dGhlbnRpY2F0aW9uXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnLCBkZXBzOiBbQVVUSEVOVElDQVRJT05fU0VSVklDRV9PUFRJT05TXSwgdXNlRmFjdG9yeTogYXV0aGVudGljYXRpb25TZXJ2aWNlRmFjdG9yeX0pXHJcbmV4cG9ydCBjbGFzcyBBdXRoZW50aWNhdGlvblNlcnZpY2U8VFVzZXJJbmZvPlxyXG57XHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHJpdmF0ZSBmaWVsZHMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogQXV0aGVudGljYXRpb24gcHJvbWlzZSB0aGF0IHdhcyB1c2VkIGZvciBhdXRoZW50aWNhdGlvblxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9hdXRoZW50aWNhdGlvblByb21pc2U6IFByb21pc2U8VXNlcklkZW50aXR5PFRVc2VySW5mbz4+fG51bGw7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXNvbHZlZCBmdW5jdGlvbiBmb3IgaXNJbml0aWFsaXplZFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9pc0luaXRpYWxpemVkUmVzb2x2ZXI6IChpbmRpY2F0aW9uOiBib29sZWFuKSA9PiB2b2lkO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogU3ViamVjdCB1c2VkIGZvciBpbmRpY2F0aW5nIGF1dGhlbnRpY2F0aW9uQ2hhbmdlZFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9hdXRoZW50aWNhdGlvbkNoYW5nZWRTdWJqZWN0OiBTdWJqZWN0PFVzZXJJZGVudGl0eTxUVXNlckluZm8+PiA9IG5ldyBTdWJqZWN0PFVzZXJJZGVudGl0eTxUVXNlckluZm8+PigpO1xyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwdWJsaWMgcHJvcGVydGllcyAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbmRpY2F0aW9uIHdoZXRoZXIgaXMgYXV0aGVudGljYXRpb24gbW9kdWxlIGluaXRpYWxpemVkIG9yIG5vdFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaXNJbml0aWFsaXplZDogUHJvbWlzZTxib29sZWFuPjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldHMgb2JzZXJ2YWJsZSB0aGF0IGluZGljYXRlcyB3aGVuIGF1dGhlbnRpY2F0aW9uIGhhcyBjaGFuZ2VkXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXQgYXV0aGVudGljYXRpb25DaGFuZ2VkKCk6IE9ic2VydmFibGU8VXNlcklkZW50aXR5PFRVc2VySW5mbz4+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2F1dGhlbnRpY2F0aW9uQ2hhbmdlZFN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIGNvbnN0cnVjdG9yICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuICAgIC8vVE9ETyAtIHJlcG9ydCBidWcsIHRoaXMgaXMgSEFDSyB0byBiZSBjb21waWxhYmxlXHJcbiAgICBjb25zdHJ1Y3RvcihASW5qZWN0KEluamVjdG9yKSBwcml2YXRlIF9vcHRpb25zOiBBdXRoZW50aWNhdGlvblNlcnZpY2VPcHRpb25zPFRVc2VySW5mbz4pXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB0aGlzLl9pc0luaXRpYWxpemVkUmVzb2x2ZXIgPSByZXNvbHZlKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHVibGljIG1ldGhvZHMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogVGVzdHMgd2hldGhlciBpcyB1c2VkIGF1dGhvcml6ZWQgZm9yIHNwZWNpZmllZCBwZXJtaXNzaW9uXHJcbiAgICAgKiBAcGFyYW0gcGVybWlzc2lvbiBQZXJtaXNzaW9uIG5hbWUgdGhhdCBpcyB0ZXN0ZWRcclxuICAgICAqIEByZXR1cm5zIFByb21pc2U8Ym9vbGVhbj4gVHJ1ZSBpZiB1c2VyIGlzIGF1dGhvcml6ZWQgb3RoZXJ3aXNlIGZhbHNlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBpc0F1dGhvcml6ZWQocGVybWlzc2lvbjogc3RyaW5nKSA6IFByb21pc2U8Ym9vbGVhbj5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT5cclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0VXNlcklkZW50aXR5KClcclxuICAgICAgICAgICAgICAgIC50aGVuKCh1c2VySWRlbnRpdHk6IFVzZXJJZGVudGl0eTxUVXNlckluZm8+KSA9PlxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKGlzQXJyYXkodXNlcklkZW50aXR5LnBlcm1pc3Npb25zKSlcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHVzZXJJZGVudGl0eS5wZXJtaXNzaW9ucy5pbmRleE9mKHBlcm1pc3Npb24pID4gLTEpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGVycm9yID0+IHJlamVjdChlcnJvcikpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyB1c2VyIGlkZW50aXR5XHJcbiAgICAgKiBAcGFyYW0gcmVmcmVzaD8gSW5kaWNhdGlvbiB0aGF0IHNlcnZlciBnZXQgdXNlciBpZGVudGl0eSBzaG91bGQgYmUgY2FsbGVkLCBvdGhlcndpc2UgY2FjaGVkIHJlc3BvbnNlIHdpbGwgYmUgdXNlZFxyXG4gICAgICogQHJldHVybnMgUHJvbWlzZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZ2V0VXNlcklkZW50aXR5KHJlZnJlc2g/OiBib29sZWFuKTogUHJvbWlzZTxVc2VySWRlbnRpdHk8VFVzZXJJbmZvPj5cclxuICAgIHtcclxuICAgICAgICBpZihyZWZyZXNoID09PSB0cnVlKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fYXV0aGVudGljYXRpb25Qcm9taXNlID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHRoaXMuX2F1dGhlbnRpY2F0aW9uUHJvbWlzZSAhPSBudWxsKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2F1dGhlbnRpY2F0aW9uUHJvbWlzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2F1dGhlbnRpY2F0aW9uUHJvbWlzZSA9IG5ldyBQcm9taXNlKChzdWNjZXNzLCByZWplY3QpID0+XHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLl9vcHRpb25zXHJcbiAgICAgICAgICAgICAgICAuZ2V0VXNlcklkZW50aXR5KClcclxuICAgICAgICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IoZXJyb3IgPT5cclxuICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWRSZXNvbHZlcih0cnVlKTtcclxuICBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgIH0pKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoaXRtOiBVc2VySWRlbnRpdHk8VFVzZXJJbmZvPikgPT5cclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzKGl0bSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXV0aGVudGljYXRpb25DaGFuZ2VkU3ViamVjdC5uZXh0KGl0bSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5faXNJbml0aWFsaXplZFJlc29sdmVyKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLl9hdXRoZW50aWNhdGlvblByb21pc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBNZXRob2QgbG9ncyB1c2VyIGludG8gc3lzdGVtXHJcbiAgICAgKiBAcGFyYW0gYWNjZXNzVG9rZW4gQWNjZXNzIHRva2VuIGhvbGRpbmcgYXV0aGVudGljYXRpb24gaW5mb3JtYXRpb25cclxuICAgICAqIEByZXR1cm5zIE9ic2VydmFibGVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGxvZ2luKGFjY2Vzc1Rva2VuOiBBY2Nlc3NUb2tlbik6IE9ic2VydmFibGU8YW55PlxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzZXJ2ZXI6IE9ic2VydmVyPGFueT4pID0+XHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLl9vcHRpb25zLmxvZ2luKGFjY2Vzc1Rva2VuKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PlxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0VXNlcklkZW50aXR5KHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSwgZXJyb3IgPT5cclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIE1ldGhvZHMgbG9ncyBvdXQgdXNlciBvdXQgb2Ygc3lzdGVtXHJcbiAgICAgKiBAcmV0dXJucyBPYnNlcnZhYmxlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBsb2dvdXQoKTogT2JzZXJ2YWJsZTxhbnk+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogT2JzZXJ2ZXI8YW55PikgPT5cclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnMubG9nb3V0KClcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT5cclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFVzZXJJZGVudGl0eSh0cnVlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0sIGVycm9yID0+XHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZWRpcmVjdHMgY3VycmVudCBwYWdlIHRvIGF1dGhlbnRpY2F0aW9uIHBhZ2VcclxuICAgICAqL1xyXG4gICAgcHVibGljIHNob3dBdXRoUGFnZSgpOiBQcm9taXNlPGJvb2xlYW4+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX29wdGlvbnMuc2hvd0F1dGhQYWdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZWRpcmVjdHMgY3VycmVudCBwYWdlIHRvIGFjY2VzcyBkZW5pZWQgcGFnZVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2hvd0FjY2Vzc0RlbmllZCgpOiBQcm9taXNlPGJvb2xlYW4+XHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX29wdGlvbnMuc2hvd0FjY2Vzc0RlbmllZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyBpbmRpY2F0aW8gd2hldGhlciBjdXJyZW50IHN0YXRlIG9mIGFwcCBpcyBkaXNwbGF5aW5nIGxvZ2luIHBhZ2VcclxuICAgICAqIEByZXR1cm5zIGJvb2xlYW5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGlzQXV0aFBhZ2UoKTogYm9vbGVhblxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9vcHRpb25zLmlzQXV0aFBhZ2UoKTtcclxuICAgIH1cclxufSJdfQ==