var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ChangeDetectionStrategy, Inject, Optional, ElementRef } from '@angular/core';
import { extend, isBlank } from '@asseco/common';
import { NG_SELECT_PLUGIN_INSTANCES } from '../../../components/select/types';
import { VALUE_HANDLER_OPTIONS } from '../types';
import { ValueHandlerBase } from '../valueHandlerBase';
const ɵ0 = /**
 * @param {?} value
 * @return {?}
 */
value => value;
/**
 * Default options for value handler
 * \@internal
 * @type {?}
 */
const defaultOptions = {
    textExtractor: (ɵ0)
};
/**
 * Component used for handling current value of NgSelect, allows values which are not present in options
 * @template TValue
 */
export class DynamicValueHandlerComponent extends ValueHandlerBase {
    //######################### constructor #########################
    /**
     * @param {?} ngSelectPlugins
     * @param {?} pluginElement
     * @param {?=} options
     */
    constructor(ngSelectPlugins, pluginElement, options) {
        super(ngSelectPlugins, pluginElement);
        //######################### protected methods #########################
        /**
         * Sets value
         */
        this._setValue = (/**
         * @param {?} option
         * @return {?}
         */
        (option) => {
            //multiple values are allowed
            if (this.options.multiple) {
                if (!Array.isArray(this.selectedOptions)) {
                    this.selectedOptions = [];
                }
                else {
                    /** @type {?} */
                    let opt;
                    //value exists, removing from list
                    if ((opt = this.selectedOptions.find((/**
                     * @param {?} selOpt
                     * @return {?}
                     */
                    selOpt => this.valueComparer(selOpt.value, opt.value))))) {
                        /** @type {?} */
                        let index = this.selectedOptions.indexOf(option);
                        this.selectedOptions.splice(index, 1);
                    }
                    //adding value
                    else {
                        this.selectedOptions.push(option);
                    }
                }
            }
            else 
            //only signle value allowed
            {
                this.selectedOptions = option;
            }
            this._clearSelected();
            this._markValueAsSelected();
            this._normalState.invalidateVisuals();
            this.valueChange.emit();
            //close popup if not multiple
            if (!this.options.multiple) {
                this.popupVisibilityRequest.emit(false);
            }
            else {
                this._popup.invalidateVisuals();
            }
        });
        this._options = extend(true, {}, defaultOptions, options);
    }
    //######################### public properties - implementation of DynamicValueHandler #########################
    /**
     * Options for NgSelect plugin
     * @return {?}
     */
    get options() {
        return this._options;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    set options(options) {
        this._options = extend(true, this._options, options);
    }
    //######################### public methods - implementation of DynamicValueHandler #########################
    /**
     * Sets value for NgSelect
     * @param {?} value Value to be set
     * @return {?}
     */
    setValue(value) {
        this._useOptionsAsValue(value);
    }
    /**
     * Initialize plugin options, all operations required to be done with plugin options are handled here
     * @return {?}
     */
    initOptions() {
    }
    /**
     * Explicitly runs invalidation of content (change detection)
     * @return {?}
     */
    invalidateVisuals() {
    }
    /**
     * Loads options
     * @protected
     * @return {?}
     */
    _loadOptions() {
    }
    /**
     * Converts value to options
     * @protected
     * @param {?} value Value to be changed to options
     * @return {?}
     */
    _useOptionsAsValue(value) {
        return __awaiter(this, void 0, void 0, function* () {
            //set empty value
            if (isBlank(value) || (Array.isArray(value) && !value.length)) {
                this.selectedOptions = value;
                this._clearSelected();
                this._normalState.invalidateVisuals();
                this.valueChange.emit();
                return;
            }
            if (this.options.multiple) {
                if (Array.isArray(value)) {
                    /** @type {?} */
                    let items = value;
                    /** @type {?} */
                    let options = [];
                    for (let itm of items) {
                        options.push(yield this._loadText(itm));
                    }
                    this.selectedOptions = options;
                }
                else {
                    throw new Error('Don`t you have redundant "multiple"?');
                }
            }
            else {
                if (Array.isArray(value)) {
                    throw new Error('Are you missing attribute "multiple"?');
                }
                else {
                    /** @type {?} */
                    let item = value;
                    this.selectedOptions = yield this._loadText(item);
                }
            }
            this._clearSelected();
            this._markValueAsSelected();
            this._normalState.invalidateVisuals();
            this.valueChange.emit();
        });
    }
    /**
     * Loads text for specified value
     * @protected
     * @param {?} value Value that is going to be used for obtaining option
     * @return {?}
     */
    _loadText(value) {
        return __awaiter(this, void 0, void 0, function* () {
            //load option dynamically
            if (this.options.dynamicOptionsCallback) {
                /** @type {?} */
                let opts = yield this.options.dynamicOptionsCallback(value);
                if (opts && opts.length) {
                    /** @type {?} */
                    let opt = opts[0];
                    opt.value = value;
                    opt.selected = true;
                    return opt;
                }
            }
            //load option from value
            return (/** @type {?} */ ({
                selected: true,
                active: false,
                value: value,
                text: this.options.textExtractor(value)
            }));
        });
    }
}
DynamicValueHandlerComponent.decorators = [
    { type: Component, args: [{
                selector: "ng-dynamic-value-handler",
                template: '',
                changeDetection: ChangeDetectionStrategy.OnPush
            }] }
];
/** @nocollapse */
DynamicValueHandlerComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [NG_SELECT_PLUGIN_INSTANCES,] }, { type: Optional }] },
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [VALUE_HANDLER_OPTIONS,] }, { type: Optional }] }
];
if (false) {
    /**
     * Sets value
     * @type {?}
     * @protected
     */
    DynamicValueHandlerComponent.prototype._setValue;
}
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY1ZhbHVlSGFuZGxlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvcGx1Z2lucy92YWx1ZUhhbmRsZXIvZHluYW1pYy9keW5hbWljVmFsdWVIYW5kbGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQy9GLE9BQU8sRUFBQyxNQUFNLEVBQUUsT0FBTyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFJL0MsT0FBTyxFQUFDLDBCQUEwQixFQUFDLE1BQU0sa0NBQWtDLENBQUM7QUFDNUUsT0FBTyxFQUFDLHFCQUFxQixFQUFDLE1BQU0sVUFBVSxDQUFDO0FBRS9DLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHFCQUFxQixDQUFDOzs7OztBQVFsQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUs7Ozs7OztNQUYzQixjQUFjLEdBQ3BCO0lBQ0ksYUFBYSxNQUFnQjtDQUNoQzs7Ozs7QUFXRCxNQUFNLE9BQU8sNEJBQXFDLFNBQVEsZ0JBQTREOzs7Ozs7O0lBaUJsSCxZQUE0RCxlQUF3QyxFQUN4RixhQUF5QixFQUNrQixPQUE0QztRQUUvRixLQUFLLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDOzs7OztRQW1DaEMsY0FBUzs7OztRQUFHLENBQUMsTUFBK0IsRUFBRSxFQUFFO1lBRXRELDZCQUE2QjtZQUM3QixJQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUN4QjtnQkFDSSxJQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQ3ZDO29CQUNJLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO2lCQUM3QjtxQkFFRDs7d0JBQ1EsR0FB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LElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUM7YUFDMUMsRUFBQSxDQUFDO1FBQ04sQ0FBQztLQUFBOzs7WUE3TUosU0FBUyxTQUNWO2dCQUNJLFFBQVEsRUFBRSwwQkFBMEI7Z0JBQ3BDLFFBQVEsRUFBRSxFQUFFO2dCQUNaLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO2FBQ2xEOzs7OzRDQWtCZ0IsTUFBTSxTQUFDLDBCQUEwQixjQUFHLFFBQVE7WUE3Q0MsVUFBVTs0Q0ErQ3ZELE1BQU0sU0FBQyxxQkFBcUIsY0FBRyxRQUFROzs7Ozs7OztJQXFDcEQsaURBK0NDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBJbmplY3QsIE9wdGlvbmFsLCBFbGVtZW50UmVmfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtleHRlbmQsIGlzQmxhbmt9IGZyb20gJ0Bhc3NlY28vY29tbW9uJztcclxuXHJcbmltcG9ydCB7RHluYW1pY1ZhbHVlSGFuZGxlck9wdGlvbnMsIER5bmFtaWNWYWx1ZUhhbmRsZXJ9IGZyb20gJy4vZHluYW1pY1ZhbHVlSGFuZGxlci5pbnRlcmZhY2UnO1xyXG5pbXBvcnQge05nU2VsZWN0UGx1Z2luSW5zdGFuY2VzfSBmcm9tICcuLi8uLi8uLi9jb21wb25lbnRzL3NlbGVjdCc7XHJcbmltcG9ydCB7TkdfU0VMRUNUX1BMVUdJTl9JTlNUQU5DRVN9IGZyb20gJy4uLy4uLy4uL2NvbXBvbmVudHMvc2VsZWN0L3R5cGVzJztcclxuaW1wb3J0IHtWQUxVRV9IQU5ETEVSX09QVElPTlN9IGZyb20gJy4uL3R5cGVzJztcclxuaW1wb3J0IHvJtU5nU2VsZWN0T3B0aW9ufSBmcm9tICcuLi8uLi8uLi9jb21wb25lbnRzL29wdGlvbic7XHJcbmltcG9ydCB7VmFsdWVIYW5kbGVyQmFzZX0gZnJvbSAnLi4vdmFsdWVIYW5kbGVyQmFzZSc7XHJcblxyXG4vKipcclxuICogRGVmYXVsdCBvcHRpb25zIGZvciB2YWx1ZSBoYW5kbGVyXHJcbiAqIEBpbnRlcm5hbFxyXG4gKi9cclxuY29uc3QgZGVmYXVsdE9wdGlvbnM6IER5bmFtaWNWYWx1ZUhhbmRsZXJPcHRpb25zPGFueT4gPVxyXG57XHJcbiAgICB0ZXh0RXh0cmFjdG9yOiB2YWx1ZSA9PiB2YWx1ZVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIENvbXBvbmVudCB1c2VkIGZvciBoYW5kbGluZyBjdXJyZW50IHZhbHVlIG9mIE5nU2VsZWN0LCBhbGxvd3MgdmFsdWVzIHdoaWNoIGFyZSBub3QgcHJlc2VudCBpbiBvcHRpb25zXHJcbiAqL1xyXG5AQ29tcG9uZW50KFxyXG57XHJcbiAgICBzZWxlY3RvcjogXCJuZy1keW5hbWljLXZhbHVlLWhhbmRsZXJcIixcclxuICAgIHRlbXBsYXRlOiAnJyxcclxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEeW5hbWljVmFsdWVIYW5kbGVyQ29tcG9uZW50PFRWYWx1ZT4gZXh0ZW5kcyBWYWx1ZUhhbmRsZXJCYXNlPFRWYWx1ZSwgRHluYW1pY1ZhbHVlSGFuZGxlck9wdGlvbnM8VFZhbHVlPj4gaW1wbGVtZW50cyBEeW5hbWljVmFsdWVIYW5kbGVyPFRWYWx1ZT5cclxue1xyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHB1YmxpYyBwcm9wZXJ0aWVzIC0gaW1wbGVtZW50YXRpb24gb2YgRHluYW1pY1ZhbHVlSGFuZGxlciAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBPcHRpb25zIGZvciBOZ1NlbGVjdCBwbHVnaW5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldCBvcHRpb25zKCk6IER5bmFtaWNWYWx1ZUhhbmRsZXJPcHRpb25zPFRWYWx1ZT5cclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fb3B0aW9ucztcclxuICAgIH1cclxuICAgIHB1YmxpYyBzZXQgb3B0aW9ucyhvcHRpb25zOiBEeW5hbWljVmFsdWVIYW5kbGVyT3B0aW9uczxUVmFsdWU+KVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuX29wdGlvbnMgPSBleHRlbmQodHJ1ZSwgdGhpcy5fb3B0aW9ucywgb3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIGNvbnN0cnVjdG9yICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoTkdfU0VMRUNUX1BMVUdJTl9JTlNUQU5DRVMpIEBPcHRpb25hbCgpIG5nU2VsZWN0UGx1Z2luczogTmdTZWxlY3RQbHVnaW5JbnN0YW5jZXMsXHJcbiAgICAgICAgICAgICAgICBwbHVnaW5FbGVtZW50OiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgICAgQEluamVjdChWQUxVRV9IQU5ETEVSX09QVElPTlMpIEBPcHRpb25hbCgpIG9wdGlvbnM/OiBEeW5hbWljVmFsdWVIYW5kbGVyT3B0aW9uczxUVmFsdWU+KVxyXG4gICAge1xyXG4gICAgICAgIHN1cGVyKG5nU2VsZWN0UGx1Z2lucywgcGx1Z2luRWxlbWVudCk7XHJcblxyXG4gICAgICAgIHRoaXMuX29wdGlvbnMgPSBleHRlbmQodHJ1ZSwge30sIGRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHVibGljIG1ldGhvZHMgLSBpbXBsZW1lbnRhdGlvbiBvZiBEeW5hbWljVmFsdWVIYW5kbGVyICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldHMgdmFsdWUgZm9yIE5nU2VsZWN0XHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgVmFsdWUgdG8gYmUgc2V0XHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZXRWYWx1ZSh2YWx1ZTpUVmFsdWV8VFZhbHVlW10pOiB2b2lkXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5fdXNlT3B0aW9uc0FzVmFsdWUodmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5pdGlhbGl6ZSBwbHVnaW4gb3B0aW9ucywgYWxsIG9wZXJhdGlvbnMgcmVxdWlyZWQgdG8gYmUgZG9uZSB3aXRoIHBsdWdpbiBvcHRpb25zIGFyZSBoYW5kbGVkIGhlcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGluaXRPcHRpb25zKClcclxuICAgIHtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEV4cGxpY2l0bHkgcnVucyBpbnZhbGlkYXRpb24gb2YgY29udGVudCAoY2hhbmdlIGRldGVjdGlvbilcclxuICAgICAqL1xyXG4gICAgcHVibGljIGludmFsaWRhdGVWaXN1YWxzKCk6IHZvaWRcclxuICAgIHtcclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHJvdGVjdGVkIG1ldGhvZHMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogU2V0cyB2YWx1ZSBcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIF9zZXRWYWx1ZSA9IChvcHRpb246IMm1TmdTZWxlY3RPcHRpb248VFZhbHVlPikgPT5cclxuICAgIHtcclxuICAgICAgICAvL211bHRpcGxlIHZhbHVlcyBhcmUgYWxsb3dlZFxyXG4gICAgICAgIGlmKHRoaXMub3B0aW9ucy5tdWx0aXBsZSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGlmKCFBcnJheS5pc0FycmF5KHRoaXMuc2VsZWN0ZWRPcHRpb25zKSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9wdGlvbnMgPSBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGxldCBvcHQ6IMm1TmdTZWxlY3RPcHRpb248VFZhbHVlPjtcclxuXHJcbiAgICAgICAgICAgICAgICAvL3ZhbHVlIGV4aXN0cywgcmVtb3ZpbmcgZnJvbSBsaXN0XHJcbiAgICAgICAgICAgICAgICBpZigob3B0ID0gdGhpcy5zZWxlY3RlZE9wdGlvbnMuZmluZChzZWxPcHQgPT4gdGhpcy52YWx1ZUNvbXBhcmVyKHNlbE9wdC52YWx1ZSwgb3B0LnZhbHVlKSkpKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBpbmRleCA9IHRoaXMuc2VsZWN0ZWRPcHRpb25zLmluZGV4T2Yob3B0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkT3B0aW9ucy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy9hZGRpbmcgdmFsdWVcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkT3B0aW9ucy5wdXNoKG9wdGlvbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIC8vb25seSBzaWdubGUgdmFsdWUgYWxsb3dlZFxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9wdGlvbnMgPSBvcHRpb247XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9jbGVhclNlbGVjdGVkKCk7XHJcbiAgICAgICAgdGhpcy5fbWFya1ZhbHVlQXNTZWxlY3RlZCgpO1xyXG5cclxuICAgICAgICB0aGlzLl9ub3JtYWxTdGF0ZS5pbnZhbGlkYXRlVmlzdWFscygpO1xyXG4gICAgICAgIHRoaXMudmFsdWVDaGFuZ2UuZW1pdCgpO1xyXG5cclxuICAgICAgICAvL2Nsb3NlIHBvcHVwIGlmIG5vdCBtdWx0aXBsZVxyXG4gICAgICAgIGlmKCF0aGlzLm9wdGlvbnMubXVsdGlwbGUpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLnBvcHVwVmlzaWJpbGl0eVJlcXVlc3QuZW1pdChmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX3BvcHVwLmludmFsaWRhdGVWaXN1YWxzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTG9hZHMgb3B0aW9uc1xyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX2xvYWRPcHRpb25zKClcclxuICAgIHtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENvbnZlcnRzIHZhbHVlIHRvIG9wdGlvbnNcclxuICAgICAqIEBwYXJhbSB2YWx1ZSBWYWx1ZSB0byBiZSBjaGFuZ2VkIHRvIG9wdGlvbnNcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIGFzeW5jIF91c2VPcHRpb25zQXNWYWx1ZSh2YWx1ZTogVFZhbHVlfFRWYWx1ZVtdKVxyXG4gICAge1xyXG4gICAgICAgIC8vc2V0IGVtcHR5IHZhbHVlXHJcbiAgICAgICAgaWYoaXNCbGFuayh2YWx1ZSkgfHwgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmICF2YWx1ZS5sZW5ndGgpKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9wdGlvbnMgPSB2YWx1ZTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX2NsZWFyU2VsZWN0ZWQoKTtcclxuICAgICAgICAgICAgdGhpcy5fbm9ybWFsU3RhdGUuaW52YWxpZGF0ZVZpc3VhbHMoKTtcclxuICAgICAgICAgICAgdGhpcy52YWx1ZUNoYW5nZS5lbWl0KCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZih0aGlzLm9wdGlvbnMubXVsdGlwbGUpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHZhbHVlKSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW1zID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICBsZXQgb3B0aW9uczogybVOZ1NlbGVjdE9wdGlvbjxUVmFsdWU+W10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IobGV0IGl0bSBvZiBpdGVtcylcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnB1c2goYXdhaXQgdGhpcy5fbG9hZFRleHQoaXRtKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9wdGlvbnMgPSBvcHRpb25zO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb25gdCB5b3UgaGF2ZSByZWR1bmRhbnQgXCJtdWx0aXBsZVwiPycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkodmFsdWUpKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FyZSB5b3UgbWlzc2luZyBhdHRyaWJ1dGUgXCJtdWx0aXBsZVwiPycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgbGV0IGl0ZW0gPSB2YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkT3B0aW9ucyA9IGF3YWl0IHRoaXMuX2xvYWRUZXh0KGl0ZW0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9jbGVhclNlbGVjdGVkKCk7XHJcbiAgICAgICAgdGhpcy5fbWFya1ZhbHVlQXNTZWxlY3RlZCgpO1xyXG4gICAgICAgIHRoaXMuX25vcm1hbFN0YXRlLmludmFsaWRhdGVWaXN1YWxzKCk7XHJcbiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZS5lbWl0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBMb2FkcyB0ZXh0IGZvciBzcGVjaWZpZWQgdmFsdWVcclxuICAgICAqIEBwYXJhbSB2YWx1ZSBWYWx1ZSB0aGF0IGlzIGdvaW5nIHRvIGJlIHVzZWQgZm9yIG9idGFpbmluZyBvcHRpb25cclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIGFzeW5jIF9sb2FkVGV4dCh2YWx1ZTogVFZhbHVlKTogUHJvbWlzZTzJtU5nU2VsZWN0T3B0aW9uPFRWYWx1ZT4+XHJcbiAgICB7XHJcbiAgICAgICAgLy9sb2FkIG9wdGlvbiBkeW5hbWljYWxseVxyXG4gICAgICAgIGlmKHRoaXMub3B0aW9ucy5keW5hbWljT3B0aW9uc0NhbGxiYWNrKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgbGV0IG9wdHMgPSBhd2FpdCB0aGlzLm9wdGlvbnMuZHluYW1pY09wdGlvbnNDYWxsYmFjayh2YWx1ZSk7XHJcblxyXG4gICAgICAgICAgICBpZihvcHRzICYmIG9wdHMubGVuZ3RoKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBsZXQgb3B0OiDJtU5nU2VsZWN0T3B0aW9uPFRWYWx1ZT4gPSBvcHRzWzBdO1xyXG5cclxuICAgICAgICAgICAgICAgIG9wdC52YWx1ZSA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgb3B0LnNlbGVjdGVkID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3B0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL2xvYWQgb3B0aW9uIGZyb20gdmFsdWVcclxuICAgICAgICByZXR1cm4gPMm1TmdTZWxlY3RPcHRpb248VFZhbHVlPj5cclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlLFxyXG4gICAgICAgICAgICBhY3RpdmU6IGZhbHNlLFxyXG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUsXHJcbiAgICAgICAgICAgIHRleHQ6IHRoaXMub3B0aW9ucy50ZXh0RXh0cmFjdG9yKHZhbHVlKVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn0iXX0=