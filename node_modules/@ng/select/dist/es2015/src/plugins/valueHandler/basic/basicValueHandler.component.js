/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ChangeDetectionStrategy, Inject, Optional, ElementRef } from '@angular/core';
import { extend, isBlank } from '@asseco/common';
import { NG_SELECT_PLUGIN_INSTANCES } from '../../../components/select/types';
import { VALUE_HANDLER_OPTIONS } from '../types';
import { ValueHandlerBase } from '../valueHandlerBase';
/**
 * Default options for value handler
 * \@internal
 * @type {?}
 */
const defaultOptions = {};
/**
 * Component used for handling current value of NgSelect
 * @template TValue
 */
export class BasicValueHandlerComponent extends ValueHandlerBase {
    //######################### constructor #########################
    /**
     * @param {?} ngSelectPlugins
     * @param {?} pluginElement
     * @param {?=} options
     */
    constructor(ngSelectPlugins, pluginElement, options) {
        super(ngSelectPlugins, pluginElement);
        //######################### protected methods #########################
        /**
         * Sets value
         */
        this._setValue = (/**
         * @param {?} option
         * @return {?}
         */
        (option) => {
            //multiple values are allowed
            if (this.options.multiple) {
                if (!Array.isArray(this.selectedOptions)) {
                    this.selectedOptions = [];
                }
                if (Array.isArray(this.selectedOptions)) {
                    /** @type {?} */
                    let index;
                    //value exists, removing from list
                    if ((index = this.selectedOptions.indexOf(option)) >= 0) {
                        this.selectedOptions.splice(index, 1);
                    }
                    //adding value
                    else {
                        this.selectedOptions.push(option);
                    }
                    this.selectedOptions = [...this.selectedOptions];
                }
            }
            else 
            //only signle value allowed
            {
                this.selectedOptions = option;
            }
            this._clearSelected();
            this._markValueAsSelected();
            this._normalState.invalidateVisuals();
            this.valueChange.emit();
            //close popup if not multiple
            if (!this.options.multiple) {
                this.popupVisibilityRequest.emit(false);
            }
            else {
                this._popup.invalidateVisuals();
            }
        });
        this._options = extend(true, {}, defaultOptions, options);
    }
    //######################### public properties - implementation of BasicValueHandler #########################
    /**
     * Options for NgSelect plugin
     * @return {?}
     */
    get options() {
        return this._options;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    set options(options) {
        this._options = extend(true, this._options, options);
    }
    //######################### public methods - implementation of BasicValueHandler #########################
    /**
     * Sets value for NgSelect
     * @param {?} value Value to be set
     * @return {?}
     */
    setValue(value) {
        this._useOptionsAsValue(value);
    }
    /**
     * Initialize plugin options, all operations required to be done with plugin options are handled here
     * @return {?}
     */
    initOptions() {
    }
    /**
     * Explicitly runs invalidation of content (change detection)
     * @return {?}
     */
    invalidateVisuals() {
    }
    /**
     * Loads options
     * @protected
     * @return {?}
     */
    _loadOptions() {
        this._useOptionsAsValue(isBlank(this._unmappedValue) ? this.value : this._unmappedValue);
    }
    /**
     * Converts value to options
     * @protected
     * @param {?} value Value to be changed to options
     * @return {?}
     */
    _useOptionsAsValue(value) {
        //set empty value
        if (isBlank(value) || (Array.isArray(value) && !value.length)) {
            this.selectedOptions = value;
            this._clearSelected();
            this._unmappedValue = null;
            this._normalState.invalidateVisuals();
            this.valueChange.emit();
            return;
        }
        //no options available yet
        if (!this.optionsGatherer.options || !this.optionsGatherer.options.length) {
            this._unmappedValue = value;
            return;
        }
        if (this.options.multiple) {
            if (Array.isArray(value)) {
                /** @type {?} */
                let items = value;
                this.selectedOptions = this.optionsGatherer.options.filter((/**
                 * @param {?} itm
                 * @return {?}
                 */
                itm => !!items.find((/**
                 * @param {?} it
                 * @return {?}
                 */
                it => this.valueComparer(it, itm.value)))));
            }
            else {
                throw new Error('Don`t you have redundant "multiple"?');
            }
        }
        else {
            if (Array.isArray(value)) {
                throw new Error('Are you missing attribute "multiple"?');
            }
            else {
                /** @type {?} */
                let item = value;
                this.selectedOptions = this.optionsGatherer.options.find((/**
                 * @param {?} itm
                 * @return {?}
                 */
                itm => this.valueComparer(itm.value, item)));
            }
        }
        this._clearSelected();
        this._markValueAsSelected();
        this._unmappedValue = null;
        this._normalState.invalidateVisuals();
        this.valueChange.emit();
    }
}
BasicValueHandlerComponent.decorators = [
    { type: Component, args: [{
                selector: "ng-basic-value-handler",
                template: '',
                changeDetection: ChangeDetectionStrategy.OnPush
            }] }
];
/** @nocollapse */
BasicValueHandlerComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [NG_SELECT_PLUGIN_INSTANCES,] }, { type: Optional }] },
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [VALUE_HANDLER_OPTIONS,] }, { type: Optional }] }
];
if (false) {
    /**
     * Backed up unmapped value that was set before options were obtained
     * @type {?}
     * @protected
     */
    BasicValueHandlerComponent.prototype._unmappedValue;
    /**
     * Sets value
     * @type {?}
     * @protected
     */
    BasicValueHandlerComponent.prototype._setValue;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzaWNWYWx1ZUhhbmRsZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL3BsdWdpbnMvdmFsdWVIYW5kbGVyL2Jhc2ljL2Jhc2ljVmFsdWVIYW5kbGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUMvRixPQUFPLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBSS9DLE9BQU8sRUFBQywwQkFBMEIsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBQzVFLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUUvQyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQzs7Ozs7O01BTS9DLGNBQWMsR0FDcEIsRUFDQzs7Ozs7QUFXRCxNQUFNLE9BQU8sMEJBQW1DLFNBQVEsZ0JBQWtEOzs7Ozs7O0lBd0J0RyxZQUE0RCxlQUF3QyxFQUN4RixhQUF5QixFQUNrQixPQUFrQztRQUVyRixLQUFLLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDOzs7OztRQW1DaEMsY0FBUzs7OztRQUFHLENBQUMsTUFBK0IsRUFBRSxFQUFFO1lBRXRELDZCQUE2QjtZQUM3QixJQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUN4QjtnQkFDSSxJQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQ3ZDO29CQUNJLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO2lCQUM3QjtnQkFFRCxJQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUN0Qzs7d0JBQ1EsS0FBYTtvQkFFakIsa0NBQWtD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RUFBRTtnQkFDWixlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTthQUNsRDs7Ozs0Q0F5QmdCLE1BQU0sU0FBQywwQkFBMEIsY0FBRyxRQUFRO1lBbkRDLFVBQVU7NENBcUR2RCxNQUFNLFNBQUMscUJBQXFCLGNBQUcsUUFBUTs7Ozs7Ozs7SUFuQnBELG9EQUEwQzs7Ozs7O0lBd0QxQywrQ0FpREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIEluamVjdCwgT3B0aW9uYWwsIEVsZW1lbnRSZWZ9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge2V4dGVuZCwgaXNCbGFua30gZnJvbSAnQGFzc2Vjby9jb21tb24nO1xyXG5cclxuaW1wb3J0IHtCYXNpY1ZhbHVlSGFuZGxlck9wdGlvbnMsIEJhc2ljVmFsdWVIYW5kbGVyfSBmcm9tICcuL2Jhc2ljVmFsdWVIYW5kbGVyLmludGVyZmFjZSc7XHJcbmltcG9ydCB7TmdTZWxlY3RQbHVnaW5JbnN0YW5jZXN9IGZyb20gJy4uLy4uLy4uL2NvbXBvbmVudHMvc2VsZWN0JztcclxuaW1wb3J0IHtOR19TRUxFQ1RfUExVR0lOX0lOU1RBTkNFU30gZnJvbSAnLi4vLi4vLi4vY29tcG9uZW50cy9zZWxlY3QvdHlwZXMnO1xyXG5pbXBvcnQge1ZBTFVFX0hBTkRMRVJfT1BUSU9OU30gZnJvbSAnLi4vdHlwZXMnO1xyXG5pbXBvcnQge8m1TmdTZWxlY3RPcHRpb24sIH0gZnJvbSAnLi4vLi4vLi4vY29tcG9uZW50cy9vcHRpb24nO1xyXG5pbXBvcnQge1ZhbHVlSGFuZGxlckJhc2V9IGZyb20gJy4uL3ZhbHVlSGFuZGxlckJhc2UnO1xyXG5cclxuLyoqXHJcbiAqIERlZmF1bHQgb3B0aW9ucyBmb3IgdmFsdWUgaGFuZGxlclxyXG4gKiBAaW50ZXJuYWxcclxuICovXHJcbmNvbnN0IGRlZmF1bHRPcHRpb25zOiBCYXNpY1ZhbHVlSGFuZGxlck9wdGlvbnMgPVxyXG57XHJcbn07XHJcblxyXG4vKipcclxuICogQ29tcG9uZW50IHVzZWQgZm9yIGhhbmRsaW5nIGN1cnJlbnQgdmFsdWUgb2YgTmdTZWxlY3RcclxuICovXHJcbkBDb21wb25lbnQoXHJcbntcclxuICAgIHNlbGVjdG9yOiBcIm5nLWJhc2ljLXZhbHVlLWhhbmRsZXJcIixcclxuICAgIHRlbXBsYXRlOiAnJyxcclxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBCYXNpY1ZhbHVlSGFuZGxlckNvbXBvbmVudDxUVmFsdWU+IGV4dGVuZHMgVmFsdWVIYW5kbGVyQmFzZTxUVmFsdWUsIEJhc2ljVmFsdWVIYW5kbGVyT3B0aW9ucz4gaW1wbGVtZW50cyBCYXNpY1ZhbHVlSGFuZGxlcjxUVmFsdWU+XHJcbntcclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwcm90ZWN0ZWQgZmllbGRzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIEJhY2tlZCB1cCB1bm1hcHBlZCB2YWx1ZSB0aGF0IHdhcyBzZXQgYmVmb3JlIG9wdGlvbnMgd2VyZSBvYnRhaW5lZFxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX3VubWFwcGVkVmFsdWU6IFRWYWx1ZXxUVmFsdWVbXTtcclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHVibGljIHByb3BlcnRpZXMgLSBpbXBsZW1lbnRhdGlvbiBvZiBCYXNpY1ZhbHVlSGFuZGxlciAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBPcHRpb25zIGZvciBOZ1NlbGVjdCBwbHVnaW5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldCBvcHRpb25zKCk6IEJhc2ljVmFsdWVIYW5kbGVyT3B0aW9uc1xyXG4gICAge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9vcHRpb25zO1xyXG4gICAgfVxyXG4gICAgcHVibGljIHNldCBvcHRpb25zKG9wdGlvbnM6IEJhc2ljVmFsdWVIYW5kbGVyT3B0aW9ucylcclxuICAgIHtcclxuICAgICAgICB0aGlzLl9vcHRpb25zID0gZXh0ZW5kKHRydWUsIHRoaXMuX29wdGlvbnMsIG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBjb25zdHJ1Y3RvciAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcbiAgICBjb25zdHJ1Y3RvcihASW5qZWN0KE5HX1NFTEVDVF9QTFVHSU5fSU5TVEFOQ0VTKSBAT3B0aW9uYWwoKSBuZ1NlbGVjdFBsdWdpbnM6IE5nU2VsZWN0UGx1Z2luSW5zdGFuY2VzLFxyXG4gICAgICAgICAgICAgICAgcGx1Z2luRWxlbWVudDogRWxlbWVudFJlZixcclxuICAgICAgICAgICAgICAgIEBJbmplY3QoVkFMVUVfSEFORExFUl9PUFRJT05TKSBAT3B0aW9uYWwoKSBvcHRpb25zPzogQmFzaWNWYWx1ZUhhbmRsZXJPcHRpb25zKVxyXG4gICAge1xyXG4gICAgICAgIHN1cGVyKG5nU2VsZWN0UGx1Z2lucywgcGx1Z2luRWxlbWVudCk7XHJcblxyXG4gICAgICAgIHRoaXMuX29wdGlvbnMgPSBleHRlbmQodHJ1ZSwge30sIGRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHVibGljIG1ldGhvZHMgLSBpbXBsZW1lbnRhdGlvbiBvZiBCYXNpY1ZhbHVlSGFuZGxlciAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTZXRzIHZhbHVlIGZvciBOZ1NlbGVjdFxyXG4gICAgICogQHBhcmFtIHZhbHVlIFZhbHVlIHRvIGJlIHNldFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2V0VmFsdWUodmFsdWU6VFZhbHVlfFRWYWx1ZVtdKTogdm9pZFxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuX3VzZU9wdGlvbnNBc1ZhbHVlKHZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEluaXRpYWxpemUgcGx1Z2luIG9wdGlvbnMsIGFsbCBvcGVyYXRpb25zIHJlcXVpcmVkIHRvIGJlIGRvbmUgd2l0aCBwbHVnaW4gb3B0aW9ucyBhcmUgaGFuZGxlZCBoZXJlXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBpbml0T3B0aW9ucygpXHJcbiAgICB7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFeHBsaWNpdGx5IHJ1bnMgaW52YWxpZGF0aW9uIG9mIGNvbnRlbnQgKGNoYW5nZSBkZXRlY3Rpb24pXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBpbnZhbGlkYXRlVmlzdWFscygpOiB2b2lkXHJcbiAgICB7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHByb3RlY3RlZCBtZXRob2RzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIFNldHMgdmFsdWUgXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfc2V0VmFsdWUgPSAob3B0aW9uOiDJtU5nU2VsZWN0T3B0aW9uPFRWYWx1ZT4pID0+XHJcbiAgICB7XHJcbiAgICAgICAgLy9tdWx0aXBsZSB2YWx1ZXMgYXJlIGFsbG93ZWRcclxuICAgICAgICBpZih0aGlzLm9wdGlvbnMubXVsdGlwbGUpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBpZighQXJyYXkuaXNBcnJheSh0aGlzLnNlbGVjdGVkT3B0aW9ucykpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRPcHRpb25zID0gW107XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkodGhpcy5zZWxlY3RlZE9wdGlvbnMpKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaW5kZXg6IG51bWJlcjtcclxuXHJcbiAgICAgICAgICAgICAgICAvL3ZhbHVlIGV4aXN0cywgcmVtb3ZpbmcgZnJvbSBsaXN0XHJcbiAgICAgICAgICAgICAgICBpZigoaW5kZXggPSB0aGlzLnNlbGVjdGVkT3B0aW9ucy5pbmRleE9mKG9wdGlvbikpID49IDApXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9wdGlvbnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vYWRkaW5nIHZhbHVlXHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9wdGlvbnMucHVzaChvcHRpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRPcHRpb25zID0gWy4uLnRoaXMuc2VsZWN0ZWRPcHRpb25zXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgLy9vbmx5IHNpZ25sZSB2YWx1ZSBhbGxvd2VkXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkT3B0aW9ucyA9IG9wdGlvbjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2NsZWFyU2VsZWN0ZWQoKTtcclxuICAgICAgICB0aGlzLl9tYXJrVmFsdWVBc1NlbGVjdGVkKCk7XHJcblxyXG4gICAgICAgIHRoaXMuX25vcm1hbFN0YXRlLmludmFsaWRhdGVWaXN1YWxzKCk7XHJcbiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZS5lbWl0KCk7XHJcblxyXG4gICAgICAgIC8vY2xvc2UgcG9wdXAgaWYgbm90IG11bHRpcGxlXHJcbiAgICAgICAgaWYoIXRoaXMub3B0aW9ucy5tdWx0aXBsZSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMucG9wdXBWaXNpYmlsaXR5UmVxdWVzdC5lbWl0KGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fcG9wdXAuaW52YWxpZGF0ZVZpc3VhbHMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBMb2FkcyBvcHRpb25zXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfbG9hZE9wdGlvbnMoKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuX3VzZU9wdGlvbnNBc1ZhbHVlKGlzQmxhbmsodGhpcy5fdW5tYXBwZWRWYWx1ZSkgPyB0aGlzLnZhbHVlIDogdGhpcy5fdW5tYXBwZWRWYWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb252ZXJ0cyB2YWx1ZSB0byBvcHRpb25zXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgVmFsdWUgdG8gYmUgY2hhbmdlZCB0byBvcHRpb25zXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfdXNlT3B0aW9uc0FzVmFsdWUodmFsdWU6IFRWYWx1ZXxUVmFsdWVbXSlcclxuICAgIHtcclxuICAgICAgICAvL3NldCBlbXB0eSB2YWx1ZVxyXG4gICAgICAgIGlmKGlzQmxhbmsodmFsdWUpIHx8IChBcnJheS5pc0FycmF5KHZhbHVlKSAmJiAhdmFsdWUubGVuZ3RoKSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRPcHRpb25zID0gdmFsdWU7XHJcblxyXG4gICAgICAgICAgICB0aGlzLl9jbGVhclNlbGVjdGVkKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX3VubWFwcGVkVmFsdWUgPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLl9ub3JtYWxTdGF0ZS5pbnZhbGlkYXRlVmlzdWFscygpO1xyXG4gICAgICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlLmVtaXQoKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vbm8gb3B0aW9ucyBhdmFpbGFibGUgeWV0XHJcbiAgICAgICAgaWYoIXRoaXMub3B0aW9uc0dhdGhlcmVyLm9wdGlvbnMgfHwgIXRoaXMub3B0aW9uc0dhdGhlcmVyLm9wdGlvbnMubGVuZ3RoKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fdW5tYXBwZWRWYWx1ZSA9IHZhbHVlO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYodGhpcy5vcHRpb25zLm11bHRpcGxlKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheSh2YWx1ZSkpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGxldCBpdGVtcyA9IHZhbHVlO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRPcHRpb25zID0gdGhpcy5vcHRpb25zR2F0aGVyZXIub3B0aW9ucy5maWx0ZXIoaXRtID0+ICEhaXRlbXMuZmluZChpdCA9PiB0aGlzLnZhbHVlQ29tcGFyZXIoaXQsIGl0bS52YWx1ZSkpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRG9uYHQgeW91IGhhdmUgcmVkdW5kYW50IFwibXVsdGlwbGVcIj8nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHZhbHVlKSlcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcmUgeW91IG1pc3NpbmcgYXR0cmlidXRlIFwibXVsdGlwbGVcIj8nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGxldCBpdGVtID0gdmFsdWU7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9wdGlvbnMgPSB0aGlzLm9wdGlvbnNHYXRoZXJlci5vcHRpb25zLmZpbmQoaXRtID0+IHRoaXMudmFsdWVDb21wYXJlcihpdG0udmFsdWUsIGl0ZW0pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fY2xlYXJTZWxlY3RlZCgpO1xyXG4gICAgICAgIHRoaXMuX21hcmtWYWx1ZUFzU2VsZWN0ZWQoKTtcclxuICAgICAgICB0aGlzLl91bm1hcHBlZFZhbHVlID0gbnVsbDtcclxuICAgICAgICB0aGlzLl9ub3JtYWxTdGF0ZS5pbnZhbGlkYXRlVmlzdWFscygpO1xyXG4gICAgICAgIHRoaXMudmFsdWVDaGFuZ2UuZW1pdCgpO1xyXG4gICAgfVxyXG59Il19