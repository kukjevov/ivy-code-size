/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ChangeDetectionStrategy, Inject, Optional, ElementRef, PLATFORM_ID } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { extend } from '@asseco/common';
import * as positions from 'positions';
import { NG_SELECT_PLUGIN_INSTANCES } from '../../../components/select/types';
import { POSITIONER_OPTIONS } from '../types';
import { POPUP } from '../../popup/types';
/**
 * Default options for positioner
 * \@internal
 * @type {?}
 */
const defaultOptions = {
    optionsCoordinates: 'top left',
    selectCoordinates: 'bottom left'
};
/**
 * Component used for positioning popup element
 */
export class BasicPositionerComponent {
    //######################### constructor #########################
    /**
     * @param {?} ngSelectPlugins
     * @param {?} pluginElement
     * @param {?=} options
     * @param {?=} _document
     * @param {?=} _platformId
     */
    constructor(ngSelectPlugins, pluginElement, options, _document, _platformId) {
        this.ngSelectPlugins = ngSelectPlugins;
        this.pluginElement = pluginElement;
        this._document = _document;
        this._platformId = _platformId;
        /**
         * Indication whether is code running in browser
         */
        this._isBrowser = isPlatformBrowser(this._platformId);
        //######################### protected methods #########################
        /**
         * Handles resize and scroll event
         */
        this._handleResizeAndScroll = (/**
         * @return {?}
         */
        () => {
            this._calculatePositionAndDimensions();
        });
        this._options = extend(true, {}, defaultOptions, options);
    }
    //######################### public properties - implementation of BasicPositioner #########################
    /**
     * Options for NgSelect plugin
     * @return {?}
     */
    get options() {
        return this._options;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    set options(options) {
        this._options = extend(true, this._options, options);
    }
    //######################### public methods - implementation of OnDestroy #########################
    /**
     * Called when component is destroyed
     * @return {?}
     */
    ngOnDestroy() {
        if (this._visibilitySubscription) {
            this._visibilitySubscription.unsubscribe();
            this._visibilitySubscription = null;
        }
        if (this._optionsChangeSubscription) {
            this._optionsChangeSubscription.unsubscribe();
            this._optionsChangeSubscription = null;
        }
        if (this._isBrowser) {
            window.removeEventListener('resize', this._handleResizeAndScroll);
            window.removeEventListener('scroll', this._handleResizeAndScroll);
        }
    }
    //######################### public methods - implementation of BasicPositioner #########################
    /**
     * Initialize plugin, to be ready to use, initialize communication with other plugins
     * @return {?}
     */
    initialize() {
        if (this._optionsGatherer && this._optionsGatherer != this.optionsGatherer) {
            this._optionsChangeSubscription.unsubscribe();
            this._optionsChangeSubscription = null;
            this._optionsGatherer = null;
        }
        if (!this._optionsGatherer) {
            this._optionsGatherer = this.optionsGatherer;
            this._optionsChangeSubscription = this._optionsGatherer.availableOptionsChange.subscribe((/**
             * @return {?}
             */
            () => {
                if (this._popup.popupElement && this.optionsGatherer.availableOptions && this.optionsGatherer.availableOptions.length) {
                    this._handlePosition();
                }
            }));
        }
        /** @type {?} */
        let popup = (/** @type {?} */ (this.ngSelectPlugins[POPUP]));
        if (this._popup && this._popup != popup) {
            this._visibilitySubscription.unsubscribe();
            this._visibilitySubscription = null;
            this._popup = null;
        }
        if (!this._popup) {
            this._popup = popup;
            this._visibilitySubscription = this._popup.visibilityChange.subscribe((/**
             * @return {?}
             */
            () => this._handlePosition()));
        }
        this._handlePosition();
    }
    /**
     * Initialize plugin options, all operations required to be done with plugin options are handled here
     * @return {?}
     */
    initOptions() {
    }
    /**
     * Explicitly runs invalidation of content (change detection)
     * @return {?}
     */
    invalidateVisuals() {
    }
    /**
     * Handles position of popup
     * @protected
     * @return {?}
     */
    _handlePosition() {
        this._popupElement = this._popup.popupElement;
        if (this._isBrowser) {
            //register events and handle position of opened popup
            if (this._popupElement) {
                window.addEventListener('resize', this._handleResizeAndScroll);
                window.addEventListener('scroll', this._handleResizeAndScroll);
                this._handleResizeAndScroll();
            }
            //unregister events
            else {
                window.removeEventListener('resize', this._handleResizeAndScroll);
                window.removeEventListener('scroll', this._handleResizeAndScroll);
            }
        }
    }
    /**
     * Calculates positions and dimensions of popup
     * @protected
     * @return {?}
     */
    _calculatePositionAndDimensions() {
        //set to default position
        /** @type {?} */
        let popupCoordinates = positions(this._popupElement, this.options.optionsCoordinates, this.selectElement, this.options.selectCoordinates);
        this._popupElement.style.left = `${popupCoordinates.left}px`;
        this._popupElement.style.top = `${popupCoordinates.top}px`;
        this._popupElement.style.maxHeight = '';
        //flip if collision with viewport
        /** @type {?} */
        let optionsCoordinates;
        /** @type {?} */
        let selectCoordinates;
        [popupCoordinates, optionsCoordinates, selectCoordinates] = this._flipIfCollision(this._popupElement);
        this._popupElement.style.left = `${popupCoordinates.left}px`;
        this._popupElement.style.top = `${popupCoordinates.top}px`;
        //set maxHeight if there is not more place
        this._updateHeight(this._popupElement);
        popupCoordinates = positions(this._popupElement, optionsCoordinates, this.selectElement, selectCoordinates);
        this._popupElement.style.left = `${popupCoordinates.left}px`;
        this._popupElement.style.top = `${popupCoordinates.top}px`;
    }
    /**
     * Updates height of element
     * @protected
     * @param {?} popupElement Html element for popup div
     * @return {?}
     */
    _updateHeight(popupElement) {
        /** @type {?} */
        let rect = popupElement.getBoundingClientRect();
        /** @type {?} */
        let selectRect = this.selectElement.getBoundingClientRect();
        /** @type {?} */
        let h = Math.max(this._document.documentElement.clientHeight, window.innerHeight || 0);
        //popup is above
        if (rect.top < selectRect.top) {
            //space above is not enough
            popupElement.style.maxHeight = `${selectRect.top - 6}px`;
        }
        //popup is below
        else {
            //space below is not enough
            popupElement.style.maxHeight = `${h - selectRect.bottom - 6}px`;
        }
    }
    /**
     * Flips html element position if collision occur
     * @protected
     * @param {?} popupElement Html element to be flipped if collisions occur
     * @return {?}
     */
    _flipIfCollision(popupElement) {
        /** @type {?} */
        let w = Math.max(this._document.documentElement.clientWidth, window.innerWidth || 0);
        /** @type {?} */
        let h = Math.max(this._document.documentElement.clientHeight, window.innerHeight || 0);
        /** @type {?} */
        let rect = popupElement.getBoundingClientRect();
        /** @type {?} */
        let selectRect = this.selectElement.getBoundingClientRect();
        /** @type {?} */
        let spaceAbove = selectRect.top;
        /** @type {?} */
        let spaceUnder = h - selectRect.bottom;
        /** @type {?} */
        let spaceBefore = selectRect.left;
        /** @type {?} */
        let spaceAfter = w - selectRect.right;
        /** @type {?} */
        let optionsCoordinates = this.options.optionsCoordinates;
        /** @type {?} */
        let selectCoordinates = this.options.selectCoordinates;
        //vertical overflow
        if ((h < rect.bottom &&
            spaceUnder < spaceAbove) ||
            (rect.top < 0 &&
                spaceAbove < spaceUnder)) {
            optionsCoordinates = this._flipVertiacal(optionsCoordinates);
            selectCoordinates = this._flipVertiacal(selectCoordinates);
        }
        //horizontal overflow
        if ((w < (rect.left + rect.width) &&
            spaceAfter < spaceBefore) ||
            (rect.left < 0 &&
                spaceBefore < spaceAfter)) {
            optionsCoordinates = this._flipHorizontal(optionsCoordinates);
            selectCoordinates = this._flipHorizontal(selectCoordinates);
        }
        return [positions(popupElement, optionsCoordinates, this.selectElement, selectCoordinates), optionsCoordinates, selectCoordinates];
    }
    /**
     * Flips vertical position
     * @protected
     * @param {?} position Position to be flipped vertically
     * @return {?}
     */
    _flipVertiacal(position) {
        if (position.indexOf('top') >= 0) {
            return (/** @type {?} */ (position.replace('top', 'bottom')));
        }
        else if (position.indexOf('bottom') >= 0) {
            return (/** @type {?} */ (position.replace('bottom', 'top')));
        }
        return position;
    }
    /**
     * Flips horizontal position
     * @protected
     * @param {?} position Position to be flipped horizontally
     * @return {?}
     */
    _flipHorizontal(position) {
        if (position.indexOf('right') >= 0) {
            return (/** @type {?} */ (position.replace('right', 'left')));
        }
        else if (position.indexOf('left') >= 0) {
            return (/** @type {?} */ (position.replace('left', 'right')));
        }
        return position;
    }
}
BasicPositionerComponent.decorators = [
    { type: Component, args: [{
                selector: "ng-basic-positioner",
                template: '',
                changeDetection: ChangeDetectionStrategy.OnPush
            }] }
];
/** @nocollapse */
BasicPositionerComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [NG_SELECT_PLUGIN_INSTANCES,] }, { type: Optional }] },
    { type: ElementRef },
    { type: undefined, decorators: [{ type: Inject, args: [POSITIONER_OPTIONS,] }, { type: Optional }] },
    { type: HTMLDocument, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
if (false) {
    /**
     * Instance of previous options gatherer, that is used for obtaining available options
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._optionsGatherer;
    /**
     * Options for NgSelect plugin
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._options;
    /**
     * Subscription for visibility change of popup
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._visibilitySubscription;
    /**
     * Subscription for changes of options in options gatherer
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._optionsChangeSubscription;
    /**
     * Popup that is displayed
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._popup;
    /**
     * Html element of popup plugin
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._popupElement;
    /**
     * Indication whether is code running in browser
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._isBrowser;
    /**
     * HTML element that represents select itself
     * @type {?}
     */
    BasicPositionerComponent.prototype.selectElement;
    /**
     * Instance of options gatherer, that is used for obtaining available options
     * @type {?}
     */
    BasicPositionerComponent.prototype.optionsGatherer;
    /**
     * Handles resize and scroll event
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._handleResizeAndScroll;
    /** @type {?} */
    BasicPositionerComponent.prototype.ngSelectPlugins;
    /** @type {?} */
    BasicPositionerComponent.prototype.pluginElement;
    /**
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._document;
    /**
     * @type {?}
     * @protected
     */
    BasicPositionerComponent.prototype._platformId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzaWNQb3NpdGlvbmVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9wbHVnaW5zL3Bvc2l0aW9uZXIvYmFzaWMvYmFzaWNQb3NpdGlvbmVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBYSxXQUFXLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDdkgsT0FBTyxFQUFDLFFBQVEsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQzVELE9BQU8sRUFBQyxNQUFNLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUV0QyxPQUFPLEtBQUssU0FBUyxNQUFNLFdBQVcsQ0FBQztBQUt2QyxPQUFPLEVBQUMsMEJBQTBCLEVBQUMsTUFBTSxrQ0FBa0MsQ0FBQztBQUM1RSxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFFNUMsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLG1CQUFtQixDQUFDOzs7Ozs7TUFNbEMsY0FBYyxHQUNwQjtJQUNJLGtCQUFrQixFQUFFLFVBQVU7SUFDOUIsaUJBQWlCLEVBQUUsYUFBYTtDQUNuQzs7OztBQVdELE1BQU0sT0FBTyx3QkFBd0I7Ozs7Ozs7OztJQWdFakMsWUFBbUUsZUFBd0MsRUFDeEYsYUFBeUIsRUFDUSxPQUFnQyxFQUM1QyxTQUF3QixFQUNyQixXQUFvQjtRQUpJLG9CQUFlLEdBQWYsZUFBZSxDQUF5QjtRQUN4RixrQkFBYSxHQUFiLGFBQWEsQ0FBWTtRQUVKLGNBQVMsR0FBVCxTQUFTLENBQWU7UUFDckIsZ0JBQVcsR0FBWCxXQUFXLENBQVM7Ozs7UUEvQnJELGVBQVUsR0FBWSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7Ozs7O1FBaUkxRCwyQkFBc0I7OztRQUFHLEdBQUcsRUFBRTtZQUVwQyxJQUFJLENBQUMsK0JBQStCLEVBQUUsQ0FBQztRQUMzQyxDQUFDLEVBQUM7UUFuR0UsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxjQUFjLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDOUQsQ0FBQzs7Ozs7O0lBM0JELElBQVcsT0FBTztRQUVkLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDOzs7OztJQUNELElBQVcsT0FBTyxDQUFDLE9BQStCO1FBRTlDLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3pELENBQUM7Ozs7OztJQTJCTSxXQUFXO1FBRWQsSUFBRyxJQUFJLENBQUMsdUJBQXVCLEVBQy9CO1lBQ0ksSUFBSSxDQUFDLHVCQUF1QixDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzNDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUM7U0FDdkM7UUFFRCxJQUFHLElBQUksQ0FBQywwQkFBMEIsRUFDbEM7WUFDSSxJQUFJLENBQUMsMEJBQTBCLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDOUMsSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQztTQUMxQztRQUVELElBQUcsSUFBSSxDQUFDLFVBQVUsRUFDbEI7WUFDSSxNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7U0FDckU7SUFDTCxDQUFDOzs7Ozs7SUFPTSxVQUFVO1FBRWIsSUFBRyxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxlQUFlLEVBQ3pFO1lBQ0ksSUFBSSxDQUFDLDBCQUEwQixDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzlDLElBQUksQ0FBQywwQkFBMEIsR0FBRyxJQUFJLENBQUM7WUFFdkMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztTQUNoQztRQUVELElBQUcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQ3pCO1lBQ0ksSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7WUFFN0MsSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTOzs7WUFBQyxHQUFHLEVBQUU7Z0JBRTFGLElBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFDcEg7b0JBQ0ksSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2lCQUMxQjtZQUNMLENBQUMsRUFBQyxDQUFDO1NBQ047O1lBRUcsS0FBSyxHQUFVLG1CQUFBLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLEVBQVM7UUFFdkQsSUFBRyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksS0FBSyxFQUN0QztZQUNJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMzQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1lBRXBDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1NBQ3RCO1FBRUQsSUFBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQ2Y7WUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztZQUVwQixJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTOzs7WUFBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLEVBQUMsQ0FBQztTQUN2RztRQUVELElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUMzQixDQUFDOzs7OztJQUtNLFdBQVc7SUFFbEIsQ0FBQzs7Ozs7SUFLTSxpQkFBaUI7SUFFeEIsQ0FBQzs7Ozs7O0lBZVMsZUFBZTtRQUVyQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1FBRTlDLElBQUcsSUFBSSxDQUFDLFVBQVUsRUFDbEI7WUFDSSxxREFBcUQ7WUFDckQsSUFBRyxJQUFJLENBQUMsYUFBYSxFQUNyQjtnQkFDSSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO2dCQUMvRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO2dCQUUvRCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQzthQUNqQztZQUNELG1CQUFtQjtpQkFFbkI7Z0JBQ0ksTUFBTSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztnQkFDbEUsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQzthQUNyRTtTQUNKO0lBQ0wsQ0FBQzs7Ozs7O0lBS1MsK0JBQStCOzs7WUFHakMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7UUFDekksSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLENBQUM7UUFDN0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDM0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQzs7O1lBR3BDLGtCQUFrRDs7WUFDbEQsaUJBQWlEO1FBQ3JELENBQUMsZ0JBQWdCLEVBQUUsa0JBQWtCLEVBQUUsaUJBQWlCLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3RHLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxHQUFHLGdCQUFnQixDQUFDLElBQUksSUFBSSxDQUFDO1FBQzdELElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxHQUFHLGdCQUFnQixDQUFDLEdBQUcsSUFBSSxDQUFDO1FBRTNELDBDQUEwQztRQUMxQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN2QyxnQkFBZ0IsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxrQkFBa0IsRUFBRSxJQUFJLENBQUMsYUFBYSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDNUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLENBQUM7UUFDN0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDL0QsQ0FBQzs7Ozs7OztJQU1TLGFBQWEsQ0FBQyxZQUF5Qjs7WUFFekMsSUFBSSxHQUFHLFlBQVksQ0FBQyxxQkFBcUIsRUFBRTs7WUFDM0MsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUU7O1lBQ3ZELENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsV0FBVyxJQUFJLENBQUMsQ0FBQztRQUV0RixnQkFBZ0I7UUFDaEIsSUFBRyxJQUFJLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQzVCO1lBQ0ksMkJBQTJCO1lBQzNCLFlBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEdBQUcsVUFBVSxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztTQUM1RDtRQUNELGdCQUFnQjthQUVoQjtZQUNJLDJCQUEyQjtZQUMzQixZQUFZLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDO1NBQ25FO0lBQ0wsQ0FBQzs7Ozs7OztJQU1TLGdCQUFnQixDQUFDLFlBQXlCOztZQUU1QyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLFVBQVUsSUFBSSxDQUFDLENBQUM7O1lBQ2hGLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsV0FBVyxJQUFJLENBQUMsQ0FBQzs7WUFDbEYsSUFBSSxHQUFHLFlBQVksQ0FBQyxxQkFBcUIsRUFBRTs7WUFDM0MsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUU7O1lBQ3ZELFVBQVUsR0FBRyxVQUFVLENBQUMsR0FBRzs7WUFDM0IsVUFBVSxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTTs7WUFDbEMsV0FBVyxHQUFHLFVBQVUsQ0FBQyxJQUFJOztZQUM3QixVQUFVLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxLQUFLOztZQUNqQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGtCQUFrQjs7WUFDcEQsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUI7UUFFdEQsbUJBQW1CO1FBQ25CLElBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU07WUFDZixVQUFVLEdBQUcsVUFBVSxDQUFDO1lBQ3pCLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDO2dCQUNaLFVBQVUsR0FBRyxVQUFVLENBQUMsRUFDNUI7WUFDSSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDN0QsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1NBQzlEO1FBRUQscUJBQXFCO1FBQ3JCLElBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDNUIsVUFBVSxHQUFHLFdBQVcsQ0FBQztZQUMxQixDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQztnQkFDYixXQUFXLEdBQUcsVUFBVSxDQUFDLEVBQzdCO1lBQ0ksa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzlELGlCQUFpQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsQ0FBQztTQUMvRDtRQUVELE9BQU8sQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLGtCQUFrQixFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsRUFBRSxrQkFBa0IsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBQ3ZJLENBQUM7Ozs7Ozs7SUFNUyxjQUFjLENBQUMsUUFBd0M7UUFFN0QsSUFBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFDL0I7WUFDSSxPQUFPLG1CQUFBLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxFQUFrQyxDQUFDO1NBQzlFO2FBQ0ksSUFBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFDdkM7WUFDSSxPQUFPLG1CQUFBLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxFQUFrQyxDQUFDO1NBQzlFO1FBRUQsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQzs7Ozs7OztJQU1TLGVBQWUsQ0FBQyxRQUF3QztRQUU5RCxJQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUNqQztZQUNJLE9BQU8sbUJBQUEsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLEVBQWtDLENBQUM7U0FDOUU7YUFDSSxJQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUNyQztZQUNJLE9BQU8sbUJBQUEsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEVBQWtDLENBQUM7U0FDOUU7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDOzs7WUF0VUosU0FBUyxTQUNWO2dCQUNJLFFBQVEsRUFBRSxxQkFBcUI7Z0JBQy9CLFFBQVEsRUFBRSxFQUFFO2dCQUNaLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO2FBQ2xEOzs7OzRDQWlFZ0IsTUFBTSxTQUFDLDBCQUEwQixjQUFHLFFBQVE7WUFqR0MsVUFBVTs0Q0FtR3ZELE1BQU0sU0FBQyxrQkFBa0IsY0FBRyxRQUFRO1lBQ0csWUFBWSx1QkFBbkQsTUFBTSxTQUFDLFFBQVE7WUFDNkIsTUFBTSx1QkFBbEQsTUFBTSxTQUFDLFdBQVc7Ozs7Ozs7O0lBN0QvQixvREFBaUQ7Ozs7OztJQUtqRCw0Q0FBMkM7Ozs7OztJQUszQywyREFBZ0Q7Ozs7OztJQUtoRCw4REFBbUQ7Ozs7OztJQUtuRCwwQ0FBd0I7Ozs7OztJQUt4QixpREFBcUM7Ozs7OztJQUtyQyw4Q0FBb0U7Ozs7O0lBbUJwRSxpREFBa0M7Ozs7O0lBS2xDLG1EQUE2Qzs7Ozs7O0lBeUc3QywwREFHRTs7SUF6R1UsbURBQStGOztJQUMvRixpREFBZ0M7Ozs7O0lBRWhDLDZDQUFvRDs7Ozs7SUFDcEQsK0NBQW1EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBJbmplY3QsIE9wdGlvbmFsLCBFbGVtZW50UmVmLCBPbkRlc3Ryb3ksIFBMQVRGT1JNX0lEfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXJ9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7ZXh0ZW5kfSBmcm9tICdAYXNzZWNvL2NvbW1vbic7XHJcbmltcG9ydCB7U3Vic2NyaXB0aW9ufSBmcm9tICdyeGpzJztcclxuaW1wb3J0ICogYXMgcG9zaXRpb25zIGZyb20gJ3Bvc2l0aW9ucyc7XHJcblxyXG5pbXBvcnQge0Jhc2ljUG9zaXRpb25lck9wdGlvbnMsIEJhc2ljUG9zaXRpb25lcn0gZnJvbSAnLi9iYXNpY1Bvc2l0aW9uZXIuaW50ZXJmYWNlJztcclxuaW1wb3J0IHtOZ1NlbGVjdFBsdWdpbkdlbmVyaWMsIE9wdGlvbnNHYXRoZXJlcn0gZnJvbSAnLi4vLi4vLi4vbWlzYyc7XHJcbmltcG9ydCB7TmdTZWxlY3RQbHVnaW5JbnN0YW5jZXN9IGZyb20gJy4uLy4uLy4uL2NvbXBvbmVudHMvc2VsZWN0JztcclxuaW1wb3J0IHtOR19TRUxFQ1RfUExVR0lOX0lOU1RBTkNFU30gZnJvbSAnLi4vLi4vLi4vY29tcG9uZW50cy9zZWxlY3QvdHlwZXMnO1xyXG5pbXBvcnQge1BPU0lUSU9ORVJfT1BUSU9OU30gZnJvbSAnLi4vdHlwZXMnO1xyXG5pbXBvcnQge1BvcHVwfSBmcm9tICcuLi8uLi9wb3B1cCc7XHJcbmltcG9ydCB7UE9QVVB9IGZyb20gJy4uLy4uL3BvcHVwL3R5cGVzJztcclxuXHJcbi8qKlxyXG4gKiBEZWZhdWx0IG9wdGlvbnMgZm9yIHBvc2l0aW9uZXJcclxuICogQGludGVybmFsXHJcbiAqL1xyXG5jb25zdCBkZWZhdWx0T3B0aW9uczogQmFzaWNQb3NpdGlvbmVyT3B0aW9ucyA9XHJcbntcclxuICAgIG9wdGlvbnNDb29yZGluYXRlczogJ3RvcCBsZWZ0JyxcclxuICAgIHNlbGVjdENvb3JkaW5hdGVzOiAnYm90dG9tIGxlZnQnXHJcbn07XHJcblxyXG4vKipcclxuICogQ29tcG9uZW50IHVzZWQgZm9yIHBvc2l0aW9uaW5nIHBvcHVwIGVsZW1lbnRcclxuICovXHJcbkBDb21wb25lbnQoXHJcbntcclxuICAgIHNlbGVjdG9yOiBcIm5nLWJhc2ljLXBvc2l0aW9uZXJcIixcclxuICAgIHRlbXBsYXRlOiAnJyxcclxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBCYXNpY1Bvc2l0aW9uZXJDb21wb25lbnQgaW1wbGVtZW50cyBCYXNpY1Bvc2l0aW9uZXIsIE5nU2VsZWN0UGx1Z2luR2VuZXJpYzxCYXNpY1Bvc2l0aW9uZXJPcHRpb25zPiwgT25EZXN0cm95XHJcbntcclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBwcm90ZWN0ZWQgZmllbGRzICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIEluc3RhbmNlIG9mIHByZXZpb3VzIG9wdGlvbnMgZ2F0aGVyZXIsIHRoYXQgaXMgdXNlZCBmb3Igb2J0YWluaW5nIGF2YWlsYWJsZSBvcHRpb25zXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfb3B0aW9uc0dhdGhlcmVyOiBPcHRpb25zR2F0aGVyZXI8YW55PjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIE9wdGlvbnMgZm9yIE5nU2VsZWN0IHBsdWdpblxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX29wdGlvbnM6IEJhc2ljUG9zaXRpb25lck9wdGlvbnM7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTdWJzY3JpcHRpb24gZm9yIHZpc2liaWxpdHkgY2hhbmdlIG9mIHBvcHVwXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfdmlzaWJpbGl0eVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogU3Vic2NyaXB0aW9uIGZvciBjaGFuZ2VzIG9mIG9wdGlvbnMgaW4gb3B0aW9ucyBnYXRoZXJlclxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX29wdGlvbnNDaGFuZ2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIFBvcHVwIHRoYXQgaXMgZGlzcGxheWVkXHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfcG9wdXA6IFBvcHVwO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSHRtbCBlbGVtZW50IG9mIHBvcHVwIHBsdWdpblxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX3BvcHVwRWxlbWVudDogSFRNTEVsZW1lbnQ7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBJbmRpY2F0aW9uIHdoZXRoZXIgaXMgY29kZSBydW5uaW5nIGluIGJyb3dzZXJcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIF9pc0Jyb3dzZXI6IGJvb2xlYW4gPSBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLl9wbGF0Zm9ybUlkKTtcclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHVibGljIHByb3BlcnRpZXMgLSBpbXBsZW1lbnRhdGlvbiBvZiBCYXNpY1Bvc2l0aW9uZXIgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogT3B0aW9ucyBmb3IgTmdTZWxlY3QgcGx1Z2luXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXQgb3B0aW9ucygpOiBCYXNpY1Bvc2l0aW9uZXJPcHRpb25zXHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX29wdGlvbnM7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgc2V0IG9wdGlvbnMob3B0aW9uczogQmFzaWNQb3NpdGlvbmVyT3B0aW9ucylcclxuICAgIHtcclxuICAgICAgICB0aGlzLl9vcHRpb25zID0gZXh0ZW5kKHRydWUsIHRoaXMuX29wdGlvbnMsIG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSFRNTCBlbGVtZW50IHRoYXQgcmVwcmVzZW50cyBzZWxlY3QgaXRzZWxmXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzZWxlY3RFbGVtZW50OiBIVE1MRWxlbWVudDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEluc3RhbmNlIG9mIG9wdGlvbnMgZ2F0aGVyZXIsIHRoYXQgaXMgdXNlZCBmb3Igb2J0YWluaW5nIGF2YWlsYWJsZSBvcHRpb25zXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBvcHRpb25zR2F0aGVyZXI6IE9wdGlvbnNHYXRoZXJlcjxhbnk+O1xyXG5cclxuICAgIC8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyBjb25zdHJ1Y3RvciAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXHJcbiAgICBjb25zdHJ1Y3RvcihASW5qZWN0KE5HX1NFTEVDVF9QTFVHSU5fSU5TVEFOQ0VTKSBAT3B0aW9uYWwoKSBwdWJsaWMgbmdTZWxlY3RQbHVnaW5zOiBOZ1NlbGVjdFBsdWdpbkluc3RhbmNlcyxcclxuICAgICAgICAgICAgICAgIHB1YmxpYyBwbHVnaW5FbGVtZW50OiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgICAgQEluamVjdChQT1NJVElPTkVSX09QVElPTlMpIEBPcHRpb25hbCgpIG9wdGlvbnM/OiBCYXNpY1Bvc2l0aW9uZXJPcHRpb25zLFxyXG4gICAgICAgICAgICAgICAgQEluamVjdChET0NVTUVOVCkgcHJvdGVjdGVkIF9kb2N1bWVudD86IEhUTUxEb2N1bWVudCxcclxuICAgICAgICAgICAgICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByb3RlY3RlZCBfcGxhdGZvcm1JZD86IE9iamVjdClcclxuICAgIHtcclxuICAgICAgICB0aGlzLl9vcHRpb25zID0gZXh0ZW5kKHRydWUsIHt9LCBkZWZhdWx0T3B0aW9ucywgb3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIHB1YmxpYyBtZXRob2RzIC0gaW1wbGVtZW50YXRpb24gb2YgT25EZXN0cm95ICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGxlZCB3aGVuIGNvbXBvbmVudCBpcyBkZXN0cm95ZWRcclxuICAgICAqL1xyXG4gICAgcHVibGljIG5nT25EZXN0cm95KClcclxuICAgIHtcclxuICAgICAgICBpZih0aGlzLl92aXNpYmlsaXR5U3Vic2NyaXB0aW9uKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fdmlzaWJpbGl0eVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICB0aGlzLl92aXNpYmlsaXR5U3Vic2NyaXB0aW9uID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKHRoaXMuX29wdGlvbnNDaGFuZ2VTdWJzY3JpcHRpb24pXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICB0aGlzLl9vcHRpb25zQ2hhbmdlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnNDaGFuZ2VTdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYodGhpcy5faXNCcm93c2VyKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMuX2hhbmRsZVJlc2l6ZUFuZFNjcm9sbCk7XHJcbiAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLl9oYW5kbGVSZXNpemVBbmRTY3JvbGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHVibGljIG1ldGhvZHMgLSBpbXBsZW1lbnRhdGlvbiBvZiBCYXNpY1Bvc2l0aW9uZXIgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5pdGlhbGl6ZSBwbHVnaW4sIHRvIGJlIHJlYWR5IHRvIHVzZSwgaW5pdGlhbGl6ZSBjb21tdW5pY2F0aW9uIHdpdGggb3RoZXIgcGx1Z2luc1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaW5pdGlhbGl6ZSgpXHJcbiAgICB7XHJcbiAgICAgICAgaWYodGhpcy5fb3B0aW9uc0dhdGhlcmVyICYmIHRoaXMuX29wdGlvbnNHYXRoZXJlciAhPSB0aGlzLm9wdGlvbnNHYXRoZXJlcilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnNDaGFuZ2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgdGhpcy5fb3B0aW9uc0NoYW5nZVN1YnNjcmlwdGlvbiA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICB0aGlzLl9vcHRpb25zR2F0aGVyZXIgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYoIXRoaXMuX29wdGlvbnNHYXRoZXJlcilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnNHYXRoZXJlciA9IHRoaXMub3B0aW9uc0dhdGhlcmVyO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fb3B0aW9uc0NoYW5nZVN1YnNjcmlwdGlvbiA9IHRoaXMuX29wdGlvbnNHYXRoZXJlci5hdmFpbGFibGVPcHRpb25zQ2hhbmdlLnN1YnNjcmliZSgoKSA9PlxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBpZih0aGlzLl9wb3B1cC5wb3B1cEVsZW1lbnQgJiYgdGhpcy5vcHRpb25zR2F0aGVyZXIuYXZhaWxhYmxlT3B0aW9ucyAmJiB0aGlzLm9wdGlvbnNHYXRoZXJlci5hdmFpbGFibGVPcHRpb25zLmxlbmd0aClcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9oYW5kbGVQb3NpdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBwb3B1cDogUG9wdXAgPSB0aGlzLm5nU2VsZWN0UGx1Z2luc1tQT1BVUF0gYXMgUG9wdXA7XHJcblxyXG4gICAgICAgIGlmKHRoaXMuX3BvcHVwICYmIHRoaXMuX3BvcHVwICE9IHBvcHVwKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdGhpcy5fdmlzaWJpbGl0eVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICB0aGlzLl92aXNpYmlsaXR5U3Vic2NyaXB0aW9uID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3BvcHVwID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKCF0aGlzLl9wb3B1cClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHRoaXMuX3BvcHVwID0gcG9wdXA7XHJcblxyXG4gICAgICAgICAgICB0aGlzLl92aXNpYmlsaXR5U3Vic2NyaXB0aW9uID0gdGhpcy5fcG9wdXAudmlzaWJpbGl0eUNoYW5nZS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5faGFuZGxlUG9zaXRpb24oKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9oYW5kbGVQb3NpdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogSW5pdGlhbGl6ZSBwbHVnaW4gb3B0aW9ucywgYWxsIG9wZXJhdGlvbnMgcmVxdWlyZWQgdG8gYmUgZG9uZSB3aXRoIHBsdWdpbiBvcHRpb25zIGFyZSBoYW5kbGVkIGhlcmVcclxuICAgICAqL1xyXG4gICAgcHVibGljIGluaXRPcHRpb25zKClcclxuICAgIHtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEV4cGxpY2l0bHkgcnVucyBpbnZhbGlkYXRpb24gb2YgY29udGVudCAoY2hhbmdlIGRldGVjdGlvbilcclxuICAgICAqL1xyXG4gICAgcHVibGljIGludmFsaWRhdGVWaXN1YWxzKCk6IHZvaWRcclxuICAgIHtcclxuICAgIH1cclxuXHJcbiAgICAvLyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMgcHJvdGVjdGVkIG1ldGhvZHMgIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyByZXNpemUgYW5kIHNjcm9sbCBldmVudFxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX2hhbmRsZVJlc2l6ZUFuZFNjcm9sbCA9ICgpID0+XHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5fY2FsY3VsYXRlUG9zaXRpb25BbmREaW1lbnNpb25zKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogSGFuZGxlcyBwb3NpdGlvbiBvZiBwb3B1cFxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX2hhbmRsZVBvc2l0aW9uKClcclxuICAgIHtcclxuICAgICAgICB0aGlzLl9wb3B1cEVsZW1lbnQgPSB0aGlzLl9wb3B1cC5wb3B1cEVsZW1lbnQ7XHJcblxyXG4gICAgICAgIGlmKHRoaXMuX2lzQnJvd3NlcilcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIC8vcmVnaXN0ZXIgZXZlbnRzIGFuZCBoYW5kbGUgcG9zaXRpb24gb2Ygb3BlbmVkIHBvcHVwXHJcbiAgICAgICAgICAgIGlmKHRoaXMuX3BvcHVwRWxlbWVudClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMuX2hhbmRsZVJlc2l6ZUFuZFNjcm9sbCk7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5faGFuZGxlUmVzaXplQW5kU2Nyb2xsKTtcclxuICAgIFxyXG4gICAgICAgICAgICAgICAgdGhpcy5faGFuZGxlUmVzaXplQW5kU2Nyb2xsKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy91bnJlZ2lzdGVyIGV2ZW50c1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLl9oYW5kbGVSZXNpemVBbmRTY3JvbGwpO1xyXG4gICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuX2hhbmRsZVJlc2l6ZUFuZFNjcm9sbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDYWxjdWxhdGVzIHBvc2l0aW9ucyBhbmQgZGltZW5zaW9ucyBvZiBwb3B1cFxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX2NhbGN1bGF0ZVBvc2l0aW9uQW5kRGltZW5zaW9ucygpXHJcbiAgICB7XHJcbiAgICAgICAgLy9zZXQgdG8gZGVmYXVsdCBwb3NpdGlvblxyXG4gICAgICAgIGxldCBwb3B1cENvb3JkaW5hdGVzID0gcG9zaXRpb25zKHRoaXMuX3BvcHVwRWxlbWVudCwgdGhpcy5vcHRpb25zLm9wdGlvbnNDb29yZGluYXRlcywgdGhpcy5zZWxlY3RFbGVtZW50LCB0aGlzLm9wdGlvbnMuc2VsZWN0Q29vcmRpbmF0ZXMpO1xyXG4gICAgICAgIHRoaXMuX3BvcHVwRWxlbWVudC5zdHlsZS5sZWZ0ID0gYCR7cG9wdXBDb29yZGluYXRlcy5sZWZ0fXB4YDtcclxuICAgICAgICB0aGlzLl9wb3B1cEVsZW1lbnQuc3R5bGUudG9wID0gYCR7cG9wdXBDb29yZGluYXRlcy50b3B9cHhgO1xyXG4gICAgICAgIHRoaXMuX3BvcHVwRWxlbWVudC5zdHlsZS5tYXhIZWlnaHQgPSAnJztcclxuXHJcbiAgICAgICAgLy9mbGlwIGlmIGNvbGxpc2lvbiB3aXRoIHZpZXdwb3J0XHJcbiAgICAgICAgbGV0IG9wdGlvbnNDb29yZGluYXRlczogUG9zaXRpb25zLlBvc2l0aW9uc0Nvb3JkaW5hdGVzO1xyXG4gICAgICAgIGxldCBzZWxlY3RDb29yZGluYXRlczogUG9zaXRpb25zLlBvc2l0aW9uc0Nvb3JkaW5hdGVzO1xyXG4gICAgICAgIFtwb3B1cENvb3JkaW5hdGVzLCBvcHRpb25zQ29vcmRpbmF0ZXMsIHNlbGVjdENvb3JkaW5hdGVzXSA9IHRoaXMuX2ZsaXBJZkNvbGxpc2lvbih0aGlzLl9wb3B1cEVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMuX3BvcHVwRWxlbWVudC5zdHlsZS5sZWZ0ID0gYCR7cG9wdXBDb29yZGluYXRlcy5sZWZ0fXB4YDtcclxuICAgICAgICB0aGlzLl9wb3B1cEVsZW1lbnQuc3R5bGUudG9wID0gYCR7cG9wdXBDb29yZGluYXRlcy50b3B9cHhgO1xyXG5cclxuICAgICAgICAvL3NldCBtYXhIZWlnaHQgaWYgdGhlcmUgaXMgbm90IG1vcmUgcGxhY2VcclxuICAgICAgICB0aGlzLl91cGRhdGVIZWlnaHQodGhpcy5fcG9wdXBFbGVtZW50KTtcclxuICAgICAgICBwb3B1cENvb3JkaW5hdGVzID0gcG9zaXRpb25zKHRoaXMuX3BvcHVwRWxlbWVudCwgb3B0aW9uc0Nvb3JkaW5hdGVzLCB0aGlzLnNlbGVjdEVsZW1lbnQsIHNlbGVjdENvb3JkaW5hdGVzKTtcclxuICAgICAgICB0aGlzLl9wb3B1cEVsZW1lbnQuc3R5bGUubGVmdCA9IGAke3BvcHVwQ29vcmRpbmF0ZXMubGVmdH1weGA7XHJcbiAgICAgICAgdGhpcy5fcG9wdXBFbGVtZW50LnN0eWxlLnRvcCA9IGAke3BvcHVwQ29vcmRpbmF0ZXMudG9wfXB4YDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFVwZGF0ZXMgaGVpZ2h0IG9mIGVsZW1lbnRcclxuICAgICAqIEBwYXJhbSBwb3B1cEVsZW1lbnQgSHRtbCBlbGVtZW50IGZvciBwb3B1cCBkaXZcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIF91cGRhdGVIZWlnaHQocG9wdXBFbGVtZW50OiBIVE1MRWxlbWVudCk6IHZvaWRcclxuICAgIHtcclxuICAgICAgICBsZXQgcmVjdCA9IHBvcHVwRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxcclxuICAgICAgICAgICAgc2VsZWN0UmVjdCA9IHRoaXMuc2VsZWN0RWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxcclxuICAgICAgICAgICAgaCA9IE1hdGgubWF4KHRoaXMuX2RvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQsIHdpbmRvdy5pbm5lckhlaWdodCB8fCAwKTtcclxuXHJcbiAgICAgICAgLy9wb3B1cCBpcyBhYm92ZVxyXG4gICAgICAgIGlmKHJlY3QudG9wIDwgc2VsZWN0UmVjdC50b3ApXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICAvL3NwYWNlIGFib3ZlIGlzIG5vdCBlbm91Z2hcclxuICAgICAgICAgICAgcG9wdXBFbGVtZW50LnN0eWxlLm1heEhlaWdodCA9IGAke3NlbGVjdFJlY3QudG9wIC0gNn1weGA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vcG9wdXAgaXMgYmVsb3dcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICAvL3NwYWNlIGJlbG93IGlzIG5vdCBlbm91Z2hcclxuICAgICAgICAgICAgcG9wdXBFbGVtZW50LnN0eWxlLm1heEhlaWdodCA9IGAke2ggLSBzZWxlY3RSZWN0LmJvdHRvbSAtIDZ9cHhgO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEZsaXBzIGh0bWwgZWxlbWVudCBwb3NpdGlvbiBpZiBjb2xsaXNpb24gb2NjdXJcclxuICAgICAqIEBwYXJhbSBwb3B1cEVsZW1lbnQgSHRtbCBlbGVtZW50IHRvIGJlIGZsaXBwZWQgaWYgY29sbGlzaW9ucyBvY2N1clxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX2ZsaXBJZkNvbGxpc2lvbihwb3B1cEVsZW1lbnQ6IEhUTUxFbGVtZW50KTogW1Bvc2l0aW9ucy5Qb3NpdGlvbnNDc3MsIFBvc2l0aW9ucy5Qb3NpdGlvbnNDb29yZGluYXRlcywgUG9zaXRpb25zLlBvc2l0aW9uc0Nvb3JkaW5hdGVzXVxyXG4gICAge1xyXG4gICAgICAgIGxldCB3ID0gTWF0aC5tYXgodGhpcy5fZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoLCB3aW5kb3cuaW5uZXJXaWR0aCB8fCAwKSxcclxuICAgICAgICAgICAgaCA9IE1hdGgubWF4KHRoaXMuX2RvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQsIHdpbmRvdy5pbm5lckhlaWdodCB8fCAwKSxcclxuICAgICAgICAgICAgcmVjdCA9IHBvcHVwRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxcclxuICAgICAgICAgICAgc2VsZWN0UmVjdCA9IHRoaXMuc2VsZWN0RWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxcclxuICAgICAgICAgICAgc3BhY2VBYm92ZSA9IHNlbGVjdFJlY3QudG9wLFxyXG4gICAgICAgICAgICBzcGFjZVVuZGVyID0gaCAtIHNlbGVjdFJlY3QuYm90dG9tLFxyXG4gICAgICAgICAgICBzcGFjZUJlZm9yZSA9IHNlbGVjdFJlY3QubGVmdCxcclxuICAgICAgICAgICAgc3BhY2VBZnRlciA9IHcgLSBzZWxlY3RSZWN0LnJpZ2h0LFxyXG4gICAgICAgICAgICBvcHRpb25zQ29vcmRpbmF0ZXMgPSB0aGlzLm9wdGlvbnMub3B0aW9uc0Nvb3JkaW5hdGVzLFxyXG4gICAgICAgICAgICBzZWxlY3RDb29yZGluYXRlcyA9IHRoaXMub3B0aW9ucy5zZWxlY3RDb29yZGluYXRlcztcclxuXHJcbiAgICAgICAgLy92ZXJ0aWNhbCBvdmVyZmxvd1xyXG4gICAgICAgIGlmKChoIDwgcmVjdC5ib3R0b20gJiZcclxuICAgICAgICAgICAgc3BhY2VVbmRlciA8IHNwYWNlQWJvdmUpIHx8XHJcbiAgICAgICAgICAgKHJlY3QudG9wIDwgMCAmJlxyXG4gICAgICAgICAgICBzcGFjZUFib3ZlIDwgc3BhY2VVbmRlcikpXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBvcHRpb25zQ29vcmRpbmF0ZXMgPSB0aGlzLl9mbGlwVmVydGlhY2FsKG9wdGlvbnNDb29yZGluYXRlcyk7XHJcbiAgICAgICAgICAgIHNlbGVjdENvb3JkaW5hdGVzID0gdGhpcy5fZmxpcFZlcnRpYWNhbChzZWxlY3RDb29yZGluYXRlcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL2hvcml6b250YWwgb3ZlcmZsb3dcclxuICAgICAgICBpZigodyA8IChyZWN0LmxlZnQgKyByZWN0LndpZHRoKSAmJlxyXG4gICAgICAgICAgICBzcGFjZUFmdGVyIDwgc3BhY2VCZWZvcmUpIHx8XHJcbiAgICAgICAgICAgKHJlY3QubGVmdCA8IDAgJiZcclxuICAgICAgICAgICAgc3BhY2VCZWZvcmUgPCBzcGFjZUFmdGVyKSlcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIG9wdGlvbnNDb29yZGluYXRlcyA9IHRoaXMuX2ZsaXBIb3Jpem9udGFsKG9wdGlvbnNDb29yZGluYXRlcyk7XHJcbiAgICAgICAgICAgIHNlbGVjdENvb3JkaW5hdGVzID0gdGhpcy5fZmxpcEhvcml6b250YWwoc2VsZWN0Q29vcmRpbmF0ZXMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIFtwb3NpdGlvbnMocG9wdXBFbGVtZW50LCBvcHRpb25zQ29vcmRpbmF0ZXMsIHRoaXMuc2VsZWN0RWxlbWVudCwgc2VsZWN0Q29vcmRpbmF0ZXMpLCBvcHRpb25zQ29vcmRpbmF0ZXMsIHNlbGVjdENvb3JkaW5hdGVzXTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEZsaXBzIHZlcnRpY2FsIHBvc2l0aW9uXHJcbiAgICAgKiBAcGFyYW0gcG9zaXRpb24gUG9zaXRpb24gdG8gYmUgZmxpcHBlZCB2ZXJ0aWNhbGx5XHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfZmxpcFZlcnRpYWNhbChwb3NpdGlvbjogUG9zaXRpb25zLlBvc2l0aW9uc0Nvb3JkaW5hdGVzKTogUG9zaXRpb25zLlBvc2l0aW9uc0Nvb3JkaW5hdGVzXHJcbiAgICB7XHJcbiAgICAgICAgaWYocG9zaXRpb24uaW5kZXhPZigndG9wJykgPj0gMClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHJldHVybiBwb3NpdGlvbi5yZXBsYWNlKCd0b3AnLCAnYm90dG9tJykgYXMgUG9zaXRpb25zLlBvc2l0aW9uc0Nvb3JkaW5hdGVzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmKHBvc2l0aW9uLmluZGV4T2YoJ2JvdHRvbScpID49IDApXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICByZXR1cm4gcG9zaXRpb24ucmVwbGFjZSgnYm90dG9tJywgJ3RvcCcpIGFzIFBvc2l0aW9ucy5Qb3NpdGlvbnNDb29yZGluYXRlcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwb3NpdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEZsaXBzIGhvcml6b250YWwgcG9zaXRpb25cclxuICAgICAqIEBwYXJhbSBwb3NpdGlvbiBQb3NpdGlvbiB0byBiZSBmbGlwcGVkIGhvcml6b250YWxseVxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX2ZsaXBIb3Jpem9udGFsKHBvc2l0aW9uOiBQb3NpdGlvbnMuUG9zaXRpb25zQ29vcmRpbmF0ZXMpOiBQb3NpdGlvbnMuUG9zaXRpb25zQ29vcmRpbmF0ZXNcclxuICAgIHtcclxuICAgICAgICBpZihwb3NpdGlvbi5pbmRleE9mKCdyaWdodCcpID49IDApXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICByZXR1cm4gcG9zaXRpb24ucmVwbGFjZSgncmlnaHQnLCAnbGVmdCcpIGFzIFBvc2l0aW9ucy5Qb3NpdGlvbnNDb29yZGluYXRlcztcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZihwb3NpdGlvbi5pbmRleE9mKCdsZWZ0JykgPj0gMClcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHJldHVybiBwb3NpdGlvbi5yZXBsYWNlKCdsZWZ0JywgJ3JpZ2h0JykgYXMgUG9zaXRpb25zLlBvc2l0aW9uc0Nvb3JkaW5hdGVzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHBvc2l0aW9uO1xyXG4gICAgfVxyXG59Il19